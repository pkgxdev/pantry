distributable:
  url: https://download.gnome.org/sources/libsoup/{{version.marketing}}/libsoup-{{version}}.tar.xz
  strip-components: 1
versions:
  url: https://download.gnome.org/sources/libsoup/cache.json
  match: /libsoup-\d+\.\d+\.\d+\.tar\.xz/
  strip:
    - /^libsoup-/
    - /\.tar\.xz/
dependencies:
  gnome.org/glib-networking: '*'
  gnutls.org: '*'
  rockdaboot.github.io/libpsl: '*'
  kerberos.org: '*'
  gnome.org/libxml2: '*'
  sqlite.org: '*'
  nghttp2.org: '*'
  linux:
    github.com/google/brotli: '*'
build:
  dependencies:
    gnome.org/gobject-introspection: '*'
    mesonbuild.com: '*'
    ninja-build.org: '*'
    freedesktop.org/pkg-config: '*'
    python.org: ~3.11
    gnome.org/vala: '*'
  script:
    - meson setup build $MESON_ARGS
    - meson compile -C build --verbose
    - meson install -C build
    - run: |
        d=$(ls)
        ln -s $d/libsoup libsoup
      working-directory: "{{prefix}}/include"
  env:
    MESON_ARGS:
      - --prefix="{{prefix}}"
      - --libdir="{{prefix}}/lib"
      - --buildtype=release
      - --wrap-mode=nofallback
test:
  dependencies:
    linux:
      # failed with clang
      gnu.org/gcc: '*'
  script:
    - cc test.c $ARGS -o test
    - ./test
  env:
    ARGS:
      - -D_REENTRANT
      - -lgio-2.0
      - -lglib-2.0
      - -lgobject-2.0
      - -lsoup-3.0
