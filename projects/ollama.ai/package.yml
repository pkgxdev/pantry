distributable:
  url: git+https://github.com/jmorganca/ollama
  ref: v{{version}}

versions:
  github: jmorganca/ollama

build:
  dependencies:
    go.dev: ^1.21
    cmake.org: ^3
    git-scm.org: ^2
    curl.se/ca-certs: '*'
  script:
    - run: |
        git submodule init
        git submodule update
      if: '>=0.0.18'
    - go generate ./...
    - go build -ldflags="$GO_LDFLAGS" -o '{{prefix}}/bin/ollama' .
  env:
    linux:
      GO_LDFLAGS:
        # else segfaults
        - -buildmode=pie

provides:
  - bin/ollama

test:
  qa-required: true
  script:
    # 0.0.19 complains about a missing blobs directory
    - run: mkdir -p ~/.ollama/models/blobs
      if: =0.0.19
    - killall ollama || true
    - ollama serve &
    - sleep 5
    - ollama create mario -f ./Modelfile
    - ollama list | grep 'mario'
    - killall ollama || true
