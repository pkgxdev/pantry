distributable:
  url: git+https://github.com/jmorganca/ollama
  ref: v{{version}}
versions:
  github: jmorganca/ollama
platforms:
  - darwin # Available for macOS Windows & Linux support coming soon. <= from https://ollama.ai/
build:
  dependencies:
    go.dev: ^1.21
    cmake.org: ^3
    git-scm.org: ^2
  script:
    - run: |
        git submodule init
        git submodule update
      if: '>=0.0.18'
    # 0.1.18 seems to have changed these, and it's breaking x86-64 darwin builds
    - run: |
        if test -f gen_darwin.sh; then
          sed -i 's/-DLLAMA_METAL=on/-DLLAMA_METAL=off -DLLAMA_NATIVE=off -DLLAMA_AVX=on -DLLAMA_AVX2=off -DLLAMA_AVX512=off -DLLAMA_FMA=off -DLLAMA_F16C=on/' gen_darwin.sh
        fi
      if: darwin/x86-64
      working-directory: llm/llama.cpp

    - go generate ./...
    - go build .
    - mkdir -p {{prefix}}/bin
    - install ollama {{prefix}}/bin/
provides:
  - bin/ollama
test:
  qa-required: true
  script:
    # 0.0.19 complains about a missing blobs directory
    - run: mkdir -p ~/.ollama/models/blobs
      if: =0.0.19
    - killall ollama || true
    - ollama serve &
    - sleep 5
    - ollama create mario -f ./Modelfile
    - ollama list | grep 'mario'
    - killall ollama || true
