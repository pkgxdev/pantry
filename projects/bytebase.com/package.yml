distributable:
  url: https://github.com/bytebase/bytebase/archive/refs/tags/{{version.tag}}.tar.gz
  strip-components: 1

versions:
  github: bytebase/bytebase

dependencies:
  nodejs.org: '>=20.10'

build:
  dependencies:
    go.dev: ^1.22
    pnpm.io: '*'
    linux:
      # error: invalid linker name in argument '-fuse-ld=gold'
      gnu.org/gcc: '*'
  script:
    ./scripts/build_bytebase.sh {{prefix}}/bin

provides:
  - bin/bytebase

test:
  dependencies:
    curl.se: '*'
  script:
    - bytebase version | grep {{version}}
    - bytebase --port 2222 > out.log 2>&1 &
    - PID=$!
    - sleep 35
    - curl -L http://localhost:2222 | grep 'Bytebase' || cat out.log # debug
    - kill $PID
    - cat out.log | grep 'has started on port 2222'
