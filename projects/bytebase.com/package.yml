distributable:
  url: https://github.com/bytebase/bytebase/archive/refs/tags/{{version.tag}}.tar.gz
  strip-components: 1

versions:
  github: bytebase/bytebase

dependencies:
  nodejs.org: '>=20.10'

build:
  dependencies:
    go.dev: ^1.22
    pnpm.io: '*'
    linux:
      # error: invalid linker name in argument '-fuse-ld=gold'
      gnu.org/gcc: '*'
  script:
    ./scripts/build_bytebase.sh {{prefix}}/bin

provides:
  - bin/bytebase

test:
  dependencies:
    curl.se: '*'
    pkgx.sh: ^1
  script:
    - bytebase version | grep {{version}}
    - FREE_PORT=$(pkgx get-port)
    # ERROR: please run Bytebase as non-root user
    # CI runs as root, so we can't run the server
    - |
        if test "{{hw.platform}}+{{hw.arch}}" != "linux+x86-64"; then
          bytebase --port $FREE_PORT > out.log 2>&1 &
          PID=$!
          sleep 35
          curl -L http://localhost:$FREE_PORT | grep 'Bytebase' || cat out.log
          kill $PID
          cat out.log | grep "has started on port $FREE_PORT"
        fi
  env:
    # initdb: error: invalid locale settings; check LANG and LC_* environment variables
    LANG: en_US.UTF-8
    LC_COLLATE: en_US.UTF-8
    LC_CTYPE: en_US.UTF-8
    LC_MESSAGES: en_US.UTF-8
    LC_MONETARY: en_US.UTF-8
    LC_NUMERIC: en_US.UTF-8
    LC_TIME: en_US.UTF-8

