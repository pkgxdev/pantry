distributable:
  url: https://github.com/pkgxdev/pkgm/releases/download/{{ version.tag }}/pkgm-{{ version }}.tgz

versions:
  github: pkgxdev/pkgm

provides:
  - bin/pkgm

dependencies:
  pkgx.sh: ^2
  curl.se/ca-certs: '*'

build:
  - install -Dm755 pkgm {{prefix}}/bin/pkgm

test:
  - pkgm --version | grep {{version}}
  - run: pkgm local-install dua
    if: darwin
  # ^^ our self hosted macs cannot need sudo and cannot run sudo
  - run:
      - PKGX_FS="$(pkgx stat -c %d """$(pkgx +which +dua which dua)""")"
      - BIN_FS="$(pkgx stat -c %d /usr/local/bin)"
      - HOME_FS="$(pkgx stat -c %d $HOME)"
      - |
        if [ "$PKGX_FS" = "$BIN_FS" ]; then
          pkgm install dua
        elif [ "$PKGX_FS" = "$HOME_FS" ]; then
          pkgm local-install dua
        else
          # we can't test here; so we'll accept
          # but we should fix this in pkgm
          exit 0
        fi
    if: linux
  # ^^ github's runners produce cross-device linking errors
  # FIXME: https://github.com/pkgxdev/pantry/actions/runs/13814927257/job/38645701708
  # https://github.com/pkgxdev/pkgm/issues/41
  - run: pkgm install dua
    if: linux/aarch64
  - pkgm ls | grep dua
  - PATH=/usr/local/bin:$HOME/.local/bin:$PATH command -v dua
  # ^^ brewkit PATH removes /usr/local/bin
  - PATH=/usr/local/bin:$HOME/.local/bin:$PATH dua --version
  - pkgm uninstall dua
