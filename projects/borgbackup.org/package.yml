distributable:
  url: https://github.com/borgbackup/borg/archive/refs/tags/{{version.tag}}.tar.gz
  strip-components: 1

versions:
  github: borgbackup/borg

dependencies:
  pkgx.sh: ^1
  github.com/Cyan4973/xxHash: ^0.8.1

build:
  dependencies:
    python.org: ^3.9
    openssl.org: ^1.0
    facebook.com/zstd: ^1.3.0
    lz4.org: ^1.7.0
    darwin:
      macfuse.github.io: '*'
    linux:
      kernel.org/linux-headers: ^5
      savannah.nongnu.org/acl: ^2.3.1
      github.com/libfuse/libfuse: ^3
  env:
    BORG_OPENSSL_PREFIX: '{{deps.openssl.org.prefix}}'
    BORG_LIBLZ4_PREFIX: '{{deps.lz4.org.prefix}}'
    BORG_LIBZSTD_PREFIX: '{{deps.facebook.com/zstd.prefix}}'
    BORG_LIBXXHASH_PREFIX: '{{deps.github.com/Cyan4973/xxHash.prefix}}'
    BORG_LIBACL_PREFIX: '{{deps.savannah.nongnu.org/acl.prefix}}'
    PKG_CONFIG_PATH: '$PKG_CONFIG_PATH:{{deps.github.com/libfuse/libfuse.prefix}}/lib64/pkgconfig'
    linux:
      FUSE_PKG: pyfuse3
    darwin:
      FUSE_PKG: llfuse
  script:
    - bkpyvenv stage {{prefix}} {{version}}
    - ${{prefix}}/venv/bin/pip install -r requirements.d/development.txt
    - ${{prefix}}/venv/bin/pip install .[$FUSE_PKG]
    - bkpyvenv seal {{prefix}} borg borgfs

provides:
  - bin/borg
  - bin/borgfs

test:
  fixture: |
    # borg test fixture
  script:
    - borg --version | grep "^borg {{version}}"
    - borg init --encryption=none test-repo
    - borg create --compression zstd test-repo::test-archive $FIXTURE
    - borg list test-repo | grep "test-archive"
    - borg extract test-repo::test-archive
    # note that the extract path is a full subdirectory based on the original
    # absolute path of the fixture file
    - test "# borg test fixture" = "$(cat .$FIXTURE)"
    - mkdir mnt && borgfs mount test-repo mnt
    - test -f mnt/test-repo/test-archive/$FIXTURE
