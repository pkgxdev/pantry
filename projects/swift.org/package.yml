display-name: swift

warnings:
  - vendored

versions:
  github: apple/swift
  strip:
    - /^swift-/
    - /-RELEASE$/

platforms:
  - darwin/aarch64
  - linux/x86-64

dependencies:
  linux:
    gnu.org/binutils: '*'
    gnupg.org: ^2
    gnome.org/libxml2: '*'
    libgit2.org: '*'
    curl.se: '*'
    sqlite.org: ^3
    invisible-island.net/ncurses: ^6

runtime:
  env:
    TOOLCHAINS: ${{prefix}}/usr/bin/swift

build:
  dependencies:
    curl.se: '*'
  script:
    - mkdir -p {{prefix}}/bin
    - run: |
        curl -SfL "$DOWNLOAD_URL" | tar xzf - --strip-components=2
        tar xzf Payload -C {{prefix}}
        rm -rf {{prefix}}/_CodeSignature
        rm {{prefix}}/Info.plist
      if: darwin
    - run: ln -sh ../usr/bin/* {{prefix}}/bin
      working-directory: ${{prefix}}/bin
      if: darwin
    - run: |
        curl -SfL "$DOWNLOAD_URL" | tar xzf - -C {{ prefix }} --strip-components=2
      if: linux
  env:
    darwin/aarch64: { DOWNLOAD_URL: "https://download.swift.org/swift-{{version}}-release/xcode/swift-{{version}}-RELEASE/swift-{{version}}-RELEASE-osx.pkg" }
    linux/x86-64:   { DOWNLOAD_URL: "https://download.swift.org/swift-{{version}}-release/ubuntu1804/swift-{{version}}-RELEASE/swift-{{version}}-RELEASE-ubuntu18.04.tar.gz" }

provides:
  darwin:
    - bin/clang-13
    - bin/clangd
    - bin/docc
    - bin/llvm-ar
    - bin/llvm-cov
    - bin/llvm-profdata
    - bin/sourcekit-lsp
    - bin/swift-demangle
    - bin/swift-driver
    - bin/swift-frontend
    - bin/swift-help
    - bin/swift-package
    - bin/swift-plugin-server
    - bin/clang
    - bin/clang-cache
    - bin/clang-cl
    - bin/clang-cpp
    - bin/clang++
    - bin/swift
    - bin/swift-api-digester
    - bin/swift-api-extract
    - bin/swift-autolink-extract
    - bin/swift-build
    - bin/swift-experimental-sdk
    - bin/swift-package-collection
    - bin/swift-package-registry
    - bin/swift-run
    - bin/swift-symbolgraph-extract
    - bin/swift-test
    - bin/swiftc
    # follows unique programs for darwin
    - bin/dsymutil
    - bin/swift-format
    - bin/swift-api-checker.py
    - bin/swift-build-sdk-interfaces
    - bin/swift-build-tool
    - bin/swift-package
    - bin/swift-plugin-server
    - bin/swift-stdlib-tool
  linux:
    - bin/clangd
    - bin/docc
    - bin/llvm-ar
    - bin/llvm-cov
    - bin/llvm-profdata
    - bin/sourcekit-lsp
    - bin/swift-demangle
    - bin/swift-driver
    - bin/swift-frontend
    - bin/swift-help
    - bin/swift-package
    - bin/swift-plugin-server
    - bin/clang
    - bin/clang-cache
    - bin/clang-cl
    - bin/clang-cpp
    - bin/clang++
    - bin/swift
    - bin/swift-api-digester
    - bin/swift-api-extract
    - bin/swift-autolink-extract
    - bin/swift-build
    - bin/swift-experimental-sdk
    - bin/swift-package-collection
    - bin/swift-package-registry
    - bin/swift-run
    - bin/swift-symbolgraph-extract
    - bin/swift-test
    - bin/swiftc
    # follows unique programs for linux
    - bin/lld
    - bin/lldb
    - bin/lldb-argdumper
    - bin/lldb-server
    - bin/plutil
    - bin/repl_swift
    - bin/ld.lld
    - bin/ld64.lld
    - bin/lld-link

test:
  - swift --version | grep {{version}}
  - run:
      swift $FIXTURE | grep "Hello, World!"
    fixture:
      content: print("Hello, World!")
      extname: .swift
