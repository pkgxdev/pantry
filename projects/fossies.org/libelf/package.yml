distributable:
  url: https://www.mirrorservice.org/sites/ftp.netbsd.org/pub/pkgsrc/distfiles/libelf-{{version}}.tar.gz
  strip-components: 1

versions:
  - 0.8.13 # no longer developed

platforms: [darwin] # elfutils provides libelf for linux

build:
  dependencies:
    gnu.org/autoconf: "*"
    gnu.org/automake: "*"
  script:
    # old config.guess doesn't recognize aarch64
    - cp props/config.guess props/config.sub .
    - autoreconf --force --install --verbose
    - ./configure $ARGS
    - make --jobs {{ hw.concurrency }}
    - make install
  env:
    CFLAGS: -Wno-implicit-function-declaration
    ARGS:
      - --prefix="{{prefix}}"
      - --disable-debug
      - --disable-compat

test:
  - run: xxd -r -p $FIXTURE elf
    fixture: 7F454C460101010000000000000000000200030001000000548004083400000000000000000000003400200001000000000000000100000000000000008004080080040874000000740000000500000000100000B00431DB43B96980040831D2B20CCD8031C040CD8048656C6C6F20776F726C640A
  - run: cc $FIXTURE -lelf -o test
    fixture:
      extname: c
      content: |
        #include <gelf.h>
        #include <fcntl.h>
        #include <stdio.h>

        int main(void) {
          GElf_Ehdr ehdr;
          int fd = open("elf", O_RDONLY, 0);
          if (elf_version(EV_CURRENT) == EV_NONE) return 1;
          Elf *e = elf_begin(fd, ELF_C_READ, NULL);
          if (elf_kind(e) != ELF_K_ELF) return 1;
          if (gelf_getehdr(e, &ehdr) == NULL) return 1;
          printf("%d-bit ELF\\n", gelf_getclass(e) == ELFCLASS32 ? 32 : 64);
          return 0;
        }
  - ./test | tee out
  - grep "32-bit ELF" out
