distributable:
  url: git+https://github.com/project-zot/zot
  ref: ${{version.tag}}

display-name: zot

versions:
  github: project-zot/zot

build:
  dependencies:
    git-scm.org: '*'
    npmjs.com: '*'
    go.dev: ^1.25

  env:
    MODULE_PATH: $(go list -m)
    CONFIG_PACKAGE: ${MODULE_PATH}/pkg/api/config
    CONFIG_RELEASE_TAG: ${CONFIG_PACKAGE}.ReleaseTag
    CONFIG_COMMIT: ${CONFIG_PACKAGE}.Commit
    CONFIG_BINARY_TYPE: ${CONFIG_PACKAGE}.BinaryType
    CONFIG_GO_VERSION: ${CONFIG_PACKAGE}.GoVersion
    RELEASE_TAG: $(git describe --tags --abbrev=0)
    COMMIT: $(git describe --always --tags --long)
    ALL_EXTENSIONS: debug,imagetrust,lint,metrics,mgmt,profile,scrub,search,sync,ui,userprefs,events
    BINARY_TYPE: ${ALL_EXTENSIONS}
    GO_VERSION: $(go version | awk '{print $3}')
    CGO_ENABLED: 0
    GOEXPERIMENT: jsonv2
    GO_LDFLAGS:
      - -s
      - -w
      - -X ${CONFIG_RELEASE_TAG}=${RELEASE_TAG}
      - -X ${CONFIG_COMMIT}=${COMMIT}
      - -X ${CONFIG_BINARY_TYPE}=${BINARY_TYPE}
      - -X ${CONFIG_GO_VERSION}=${GO_VERSION}
    ZUI_VERSION: $(grep -m1 ZUI_VERSION Makefile | cut -d' ' -f3)
    ZUI_REPO_OWNER: $(grep -m1 ZUI_REPO_OWNER Makefile | cut -d' ' -f3)
    ZUI_REPO_NAME: $(grep -m1 ZUI_REPO_NAME Makefile | cut -d' ' -f3)
    linux:
      GO_LDFLAGS:
        - -buildmode=pie
  script:
    - rm -Rf ${ZUI_REPO_NAME}
    - rm -Rf ./pkg/extensions/build
    - git clone --depth=1 --branch ${ZUI_VERSION} https://github.com/${ZUI_REPO_OWNER}/${ZUI_REPO_NAME}
    - working-directory: ${ZUI_REPO_NAME}
      run: |
        npm install
        npm run build
    - cp -r ${ZUI_REPO_NAME}/build ./pkg/extensions/
    - go build -v
               -ldflags="${GO_LDFLAGS}"
               -tags="${ALL_EXTENSIONS}"
               -o "{{ prefix }}"/bin/zb
               ./cmd/zb
    - go build -v
               -ldflags="${GO_LDFLAGS}"
               -tags="${ALL_EXTENSIONS}"
               -o "{{ prefix }}"/bin/zli
               ./cmd/zli
    - go build -v
               -ldflags="${GO_LDFLAGS}"
               -tags="${ALL_EXTENSIONS}"
               -o "{{ prefix }}"/bin/zot
               ./cmd/zot
    - go build -v
               -ldflags="${GO_LDFLAGS}"
               -o "{{ prefix }}"/bin/zxp
               ./cmd/zxp

provides:
  - bin/zb
  - bin/zli
  - bin/zot
  - bin/zxp

test: 
  dependencies:
    jq: '*'
  fixture: |
    {
      "storage": {
        "rootDirectory": "./var/lib/registry"
      },
      "http": {
        "address": "127.0.0.1",
        "port": "5000"
      },
      "log": {
        "level": "debug"
      },
      "extensions": {
        "search": {
          "enable": true,
          "cve": {
            "updateInterval": "2h"
          }
        },
        "ui": {
          "enable": true
        }
      }
    }
  script:
    - test "$(zb --version 2>&1 | head -1 | jq --raw-output '.commit|split("-")|first')" = {{version.tag}}
    - test "$(zli --version | jq --raw-output '.commit|split("-")|first')" = {{version.tag}}
    - test "$(zot --version | jq --raw-output '.commit|split("-")|first')" = {{version.tag}}
    #
    # sadly, there is no --version flag in zxp
    #- test "$(zxp --version | jq --raw-output '.commit|split("-")|first')" = {{version.tag}}
    #
    - zot serve ${FIXTURE} &
    - PID=$!
    - sleep 5
    - zli status --url http://127.0.0.1:5000
    - STATUS=$?
    - kill -9 ${PID}
    - exit ${STATUS}
