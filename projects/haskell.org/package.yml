distributable:
  url: https://downloads.haskell.org/~ghc/{{ version}}/ghc-{{ version}}-src.tar.xz
  strip-components: 1

versions:
  - 9.2.4
  #TODO
  # github: ghc/ghc/tags
  # strip:
  #   - /^ghc-/
  #   - /-release$/


#NOTE relocatable if we edit the shell scripts

provides:
  - bin/ghc
  - bin/ghc-pkg
  - bin/ghci
  - bin/haddock
  - bin/hp2ps
  - bin/hpc
  - bin/hsc2hs
  - bin/runghc
  - bin/runhaskell

dependencies:
  gnu.org/gmp: 6
  invisible-island.net/ncurses: 6
  llvm.org: '*'
  tea.xyz/gx/cc: c99  # ghc uses `gcc` as part of its build process

build:
  dependencies:
    gnu.org/autoconf: ^2
    gnu.org/automake: ^1  # `aclocal` is used during the build for some reason
    tea.xyz/gx/make: '*'  #FIXME specifically, gnu make is *required*
    curl.se: '*'
    gnu.org/m4: '*'
    git-scm.org: ^2
    github.com/numactl/numactl: ^2 # only linux-aarch64's ghcup needs this; always worry about your deps
  script: |-
    # `ghc` needs `ghc` to bootstrap `ghc`
    # The canonical way to achieve this is with `ghcup`
    # To that end, we capture $HOME so as to no pollute the user's life with unwanted
    # stage0 tooling. Instead, everything is localized to $HOME, and can be
    # cleaned up at will, and won't capture any of the user's workflow

    export HOME="$(pwd)"
    export BOOTSTRAP_HASKELL_NONINTERACTIVE=1
    export BOOTSTRAP_HASKELL_ADJUST_BASHRC=0
    export BOOTSTRAP_HASKELL_GHC_VERSION={{ version }}
    export CC={{ deps.llvm.org.prefix }}/bin/clang
    # force use of our ld instead of llvm's on macOS
    export LD={{ tea.xyz/gx/cc.prefix }}/bin/ld

    if test -d .ghcup; then
      echo "ghcup already installed"
    else
      curl --proto '=https' --tlsv1.2 -sSf https://get-ghcup.haskell.org | sh
    fi

    PATH="$HOME/.ghcup/bin:$PATH"

    if test -e $HOME/.cabal/bin; then
      rm -r $HOME/.cabal/bin
    fi

    cabal update && cabal install alex happy

    export PATH="$HOME/.cabal/bin:$PATH"
    GHC="$HOME/.ghcup/bin/ghc"

    export CPATH=/opt/invisible-island.net/ncurses/v6/include/ncursesw:$CPATH

    # Patch out LLVM version checks (they want 12, we have 14) to force detection of `opt` and `llc`
    sed -i.bak 's/LlvmMaxVersion=13/LlvmMaxVersion=15/' configure.ac
    #FIXME oddly, they don't provide `./configure`; we have to generate it
    autoconf
    ./configure --prefix={{ prefix }}

    # This is needed so haskell doesn't try to recache its package db before we've
    # has a chances to fix the rpaths
    # This is probably FIXME
    git apply props/tea-buildrules.diff

    hadrian/build $ARGS install

    for shim in $shims; do
      sed -i.bak -e 's_="{{prefix}}_="$(dirname $(dirname $0))_' {{prefix}}/bin/$shim-{{version}} && \
        rm {{prefix}}/bin/$shim-{{version}}.bak
    done
  env:
    ARGS:
      - -j
      - --prefix={{prefix}}
      - --docs=none
    shims:
      - ghc
      - ghc-pkg
      - ghci
      - haddock
      - hp2ps
      - hpc
      - hsc2h
      - runghc
      - runhaskell

test:
  script: |
    out=$(runghc $FIXTURE)
    test "$out" = "Hello World"
  fixture:
    main = putStrLn "Hello World"
