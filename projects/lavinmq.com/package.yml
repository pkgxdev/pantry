distributable:
  url: https://github.com/cloudamqp/lavinmq/archive/refs/tags/v{{version}}.tar.gz
  strip-components: 1

versions:
  github: cloudamqp/lavinmq
  strip:
    - /^v/

platforms:
  - darwin
  - linux/x86-64  # ARM64 is not supported by package crystal-lang.org/shards

build:
  dependencies:
    gnu.org/make: ^4
    gnu.org/gcc: ^14
    crystal-lang.org: '~1.13'
    crystal-lang.org/shards: '~0.18'
    lz4.org: ^1
    # gnu.org/help2man: '*' # help2man issue
    # gnu.org/gettext: '*'  # help2man issue
    # perl.org: '*'         # help2man issue
  
  # `make install` generates man pages. This is currently blocked by an issue with help2man (see: https://github.com/pkgxdev/pantry/issues/7318)
  script: |
    # make install PREFIX="{{prefix}}"


    make lib bin/lavinmq bin/lavinmqctl bin/lavinmqperf deps extras/lavinmq.ini extras/lavinmq.service PREFIX="{{prefix}}"
    mkdir -p "{{prefix}}/etc"
    cp extras/lavinmq.ini "{{prefix}}/etc/"
    cp extras/lavinmq.service "{{prefix}}/etc/"
    mkdir -p "{{prefix}}/bin"
    cp bin/lavinmq bin/lavinmqctl bin/lavinmqperf "{{prefix}}/bin/"
  env:
    CRYSTAL_PATH: './lib:$CRYSTAL_PATH'
    MAKEFLAGS: '-j{{hw.concurrency}}'
    PREFIX: '{{prefix}}'

provides:
  - bin/lavinmq
  - bin/lavinmqctl
  - bin/lavinmqperf

test:
  script:
    - lavinmq --version   # Blocked by missing glibc
    # - test "$(lavinmq --version)" = {{version}}
