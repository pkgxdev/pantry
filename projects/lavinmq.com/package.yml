distributable:
  url: https://github.com/cloudamqp/lavinmq/archive/refs/tags/{{version.tag}}.tar.gz
  strip-components: 1

versions:
  github: cloudamqp/lavinmq

platforms:
  # - darwin  Deactivate for testing purposes
  - linux/x86-64  # TODO: ARM64 is not supported by package crystal-lang.org/shards

dependencies:
  openssl.org: ^1.1
  pcre.org/v2: 10
  hboehm.info/gc: 8

build:
  dependencies:
    gnu.org/make: ^4
    gnu.org/gcc: ^14
    crystal-lang.org: ~1.13
    crystal-lang.org/shards: ~0.18
    lz4.org: ^1
    # gnu.org/help2man: '*' # help2man issue
    # gnu.org/gettext: '*'  # help2man issue
    # perl.org: '*'         # help2man issue
  
  # `make install` generates man pages. This is currently blocked by an issue with help2man (see: https://github.com/pkgxdev/pantry/issues/7318)
  # TODO: Use make install when 7318 is resolved.
  script:
    # - make install PREFIX="{{prefix}}"


    - make -j {{hw.concurrency}} lib bin/lavinmq bin/lavinmqctl bin/lavinmqperf deps extras/lavinmq.ini extras/lavinmq.service PREFIX="{{prefix}}"
    - run: cp $SRCROOT/extras/lavinmq.{ini,service} .
      working-directory: "{{prefix}}/etc"
    - run: cp $SRCROOT/bin/lavinmq* .
      working-directory: "{{prefix}}/bin"
  env:
    CRYSTAL_PATH: './lib:$CRYSTAL_PATH'

provides:
  - bin/lavinmq
  - bin/lavinmqctl
  - bin/lavinmqperf

test: test "$(lavinmq --version)" = {{version}}
