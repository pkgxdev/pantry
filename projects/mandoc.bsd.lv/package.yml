distributable:
  url: https://mandoc.bsd.lv/snapshots/mandoc-{{version}}.tar.gz
  strip-components: 1
versions:
  url: https://mandoc.bsd.lv/snapshots
  match: /mandoc-\d+\.\d+\.\d+\.tar\.gz/
  strip:
    - /^mandoc-/
    - /\.tar\.gz/
dependencies:
  zlib.net: '*'
build:
  dependencies:
    tea.xyz/gx/cc: c99
    gnu.org/make: '*'
  script:
    - mv cgi.h.example cgi.h # For man.cgi
    - cat <<< "$LOCAl_CONFIG" > configure.local
    - ./configure
    - make --jobs {{ hw.concurrency }}
    - make --jobs {{ hw.concurrency }} install
  env:
    LOCAl_CONFIG: |
      # Sane prefixes.
      PREFIX={{prefix}}
      INCLUDEDIR={{prefix}}/include
      LIBDIR={{prefix}}/lib
      MANDIR={{prefix}}/share/man
      WWWPREFIX={{prefix}}/var/www
      EXAMPLEDIR={{prefix}}/share/examples

      # Executable names, where utilities would be replaced/duplicated.
      # The mandoc versions of the utilities are definitely *not* ready
      # for prime-time on Darwin, though some changes in HEAD are promising.
      # The "bsd" prefix (like bsdtar, bsdmake) is more informative than "m".
      BINM_MAN=bsdman
      BINM_APROPOS=bsdapropos
      BINM_WHATIS=bsdwhatis
      BINM_MAKEWHATIS=bsdmakewhatis # default is "makewhatis".
      BINM_SOELIM=bsdsoelim # conflicts with groff's soelim

      # These are names for *section 7* pages only. Several other pages are
      # prefixed "mandoc_ similar to the "groff_" pages.
      MANM_MAN=man
      MANM_MDOC=mdoc
      MANM_ROFF=mandoc_roff # This is the only one that conflicts (groff).
      MANM_EQN=eqn
      MANM_TBL=tbl

      OSNAME='$(uname -a)' # Bottom corner signature line.

      # Not quite sure what to do here. The default ("/usr/share etc.) needs
      # sudoer privileges, or will error. So just brew's manpages for now?
      MANPATH_DEFAULT={{prefix}}/share/man

      HAVE_MANPATH=0   # Our `manpath` is a symlink to system `man`.
      STATIC=          # No static linking on Darwin.

      BUILD_CGI=1
provides:
  - bin/bsdapropos
  - bin/bsdman
  - bin/bsdsoelim
  - bin/bsdwhatis
  - bin/demandoc
  - bin/mandoc
test:
  script:
    - mandoc -Thtml -Ostyle={{prefix}}/share/examples/example.style.css {{prefix}}/share/man/man1/mandoc.1