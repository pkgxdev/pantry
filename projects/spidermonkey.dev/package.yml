distributable:
  url: https://ftp.mozilla.org/pub/firefox/releases/{{version}}esr/source/firefox-{{version}}esr.source.tar.xz
  strip-components: 1

display-name: SpiderMonkey

versions:
  url: https://ftp.mozilla.org/pub/firefox/releases/
  match: /\d+\.\d+(\.\d+)esr/
  strip: /esr$/

dependencies:
  mozilla.org/nspr: '>=4.10'
  # sourceware.org/libffi: '>3.0.9'
  unicode.org: '>=76.1'
  zlib.net: '>=1.2.3'

build:
  dependencies:
    mozilla.org/cbindgen: '>=0.27.0'
    python.org: '>=3<3.14'
    rust-lang.org: '>=1.82'
  script:
    - sed -i '$i#define XP_UNIX' js/src/js-config.h.in
    - run: cp $PROP mozconfig
      prop: |
        ac_add_options --enable-project=js
        ac_add_options --prefix={{prefix}}
        ac_add_options --disable-tests
        ac_add_options --enable-strip
        ac_add_options --with-system-zlib
        ac_add_options --disable-debug-symbols
        ac_add_options --enable-js-shell
        ac_add_options --enable-jit
        ac_add_options --enable-rust-simd
        ac_add_options --with-system-icu
        ac_add_options --with-system-nspr
        # mozbuild.configure.options.InvalidOptionError: --with-system-ffi is not available in this configuration
        # ac_add_options --with-system-ffi
        ac_add_options --enable-optimize
        ac_add_options --disable-jemalloc
    - ./mach build --jobs {{ hw.concurrency }}
    - ./mach install

provides:
  - bin/js{{version.major}}
  - bin/js{{version.major}}-config

test:
  - run: js{{version.major}} $FIXTURE
    fixture:
      extname: js
      contents: console.log("Hello, world!")
