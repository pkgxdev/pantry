distributable:
  url: https://github.com/linkerd/linkerd2/archive/refs/tags/stable-{{version}}.tar.gz
  strip-components: 1

versions:
  github: linkerd/linkerd2
  match: /^stable-.*/
  strip: /^stable-/

build:
  dependencies:
    go.dev: ^1.21
  script: |
    go build -o linkerd -tags prod -mod=readonly -ldflags="$LDFLAGS" ./cli
    mkdir -p "{{ prefix }}"/bin
    mv linkerd "{{ prefix }}"/bin
  env:
    CGO_ENABLED: 0
    GO111MODULE: "on"
    LDFLAGS:
      - -extldflags=-static
      - -w
      - -s
      - -X=github.com/linkerd/linkerd2/pkg/version.Version=stable-{{version}}

provides:
  - bin/linkerd

test:
  script: |
    test "$(linkerd version --client)" = "Client version: stable-{{version}}"
    linkerd install --ignore-cluster --crds > crds.yml
    test -f crds.yml
    linkerd install --ignore-cluster > linkerd.yml
    test -f linkerd.yml
