distributable:
  url: https://github.com/hairyhenderson/gomplate/archive/refs/tags/v{{version}}.tar.gz
  strip-components: 1

versions:
  github: hairyhenderson/gomplate

build:
  dependencies:
    go.dev: ^1.19
  script: |
    go mod download
    go build -v -ldflags="$LDFLAGS"
    mkdir -p {{prefix}}/bin
    mv cmd/gomplate {{prefix}}/bin
  env:
    LDFLAGS:
      [-s, -w, "-X=version.Version={{version}}"]
    linux:
      # or segmentation fault
      # fix found here https://github.com/docker-library/golang/issues/402#issuecomment-982204575
      LDFLAGS:
      - -buildmode=pie

provides:
  - bin/gomplate
  # ^^ specify the binaries or tea magic wonâ€™t work

test:
  fixture: |
    gomplate --version
  script: |
    out="$(gomplate < $FIXTURE)"
    exp=$(cat <<EOS
    echo 'Hello, {{ .Env.USER }}' | gomplate
    EOS)

    test "$out" = "$exp"

    if [[ "$(gomplate --version)" != "v{{version}}"* ]]; then
      echo "invalid version" >&2
      exit 1
    fi
