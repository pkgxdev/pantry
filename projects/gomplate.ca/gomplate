distributable:
  url: https://github.com/dhairyhenderson/gomplate/archive/refs/tags/v{{version}}.tar.gz
  strip-components: 1

# if there’s a github then we can parse the versions
versions:
  github: hairyhenderson/gomplate/releases/tags

build:
  dependencies:
    tea.xyz/gx/cc: c99
    tea.xyz/gx/make: '*'
    cmake.org: ^3
    git-scm.org: '*'
  working-directory: build
  script: |
    # duckdb uses git to get its version
    git init ..
    git config user.email "bot@tea.xyz"
    git config user.name "teabot"
    git commit --allow-empty -mnil
    git tag v{{version}}

    cmake ..
    make --jobs {{ hw.concurrency }}
    mkdir -p "{{prefix}}"/bin
    mv duckdb "{{prefix}}"/bin
  env:
    ARGS:
      - -DCMAKE_INSTALL_PREFIX="{{prefix}}"
      - -DCMAKE_BUILD_TYPE=Release

provides:
  - bin/gomplate
  # ^^ specify the binaries or tea magic won’t work

test:
  fixture: |
    gomplate --version
  script: |
    out="$(gomplate < $FIXTURE)"
    exp=$(cat <<EOS
    echo 'Hello, {{ .Env.USER }}' | gomplate
    EOS)

    test "$out" = "$exp"

    if [[ "$(gomplate --version)" != "v{{version}}"* ]]; then
      echo "invalid version" >&2
      exit 1
    fi
