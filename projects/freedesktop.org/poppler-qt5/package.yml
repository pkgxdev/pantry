distributable:
  url: https://poppler.freedesktop.org/poppler-{{version}}.tar.xz
  strip-components: 1
display-name: poppler-qt5
versions:
  url: https://poppler.freedesktop.org/
  match: /poppler-\d+\.\d+\.\d+\.tar\.xz/
  strip:
    - /^poppler-/
    - /\.tar\.xz/
dependencies:
  gnupg.org/libassuan: '*'
  cairographics.org: '*'
  freedesktop.org/fontconfig: '*'
  freetype.org: '*'
  gnu.org/gettext: '*'
  gnome.org/glib: '*'
  gnupg.org/gpgme: '*'
  gnupg.org/libgpg-error: '*'
  libjpeg-turbo.org: '*'
  libpng.org: '*'
  simplesystems.org/libtiff: '*'
  littlecms.com: '*'
  mozilla.org/nss: '*'
  openjpeg.org: '*'
  qt.io: ~5
  curl.se: '*'
  llvm.org: '*'
build:
  dependencies:
    cmake.org: '*'
    gnome.org/gobject-introspection: '*'
    freedesktop.org/pkg-config: '*'
    gnu.org/gperf: '*'
    darwin:
      gnu.org/wget: '*'
      libpipeline.gitlab.io/libpipeline: '*'
      nasm.us: '*'
      llvm.org/clang-format: '*'
      github.com/charliermarsh/ruff: '*'
      google.github.io/snappy: '*'
      crates.io/git-trim: '*'
      crates.io/bat: '*'
      libusb.info: '*'
      github.com/westes/flex: '*'
      libuv.org: '*'
      gnu.org/help2man: '*'
      gnu.org/fribidi: '*'
      people.engr.tamu.edu/davis/suitesparse: '*'
      brxken128.github.io/dexios: '*'
      # FIXME
      # CMake Error at /opt/cmake.org/v3.27.7/var/Modules/CMakeTestCCompiler.cmake:67 (message):
      # The C compiler
      # "/opt/gnu.org/gcc/v13.2.0/bin/cc"
      gnu.org/gcc: =13.2.0
  script:
    - cmake . $CMAKE_ARGS
    - make --jobs {{ hw.concurrency }} install
    - make clean
    - cmake . -DBUILD_SHARED_LIBS=OFF $CMAKE_ARGS
    - make --jobs {{ hw.concurrency }}
    - install libpoppler.a cpp/libpoppler-cpp.a glib/libpoppler-glib.a {{prefix}}/lib/
    - run: |
        curl -L "$FONT_DATA" | tar -xz --strip-components=1
        make install prefix={{prefix}}
      working-directory: font-data
  env:
    linux:
      CC: clang
      CXX: clang++
      LD: clang
    darwin:
      AS: /usr/bin/as # not awesome
    FONT_DATA: https://poppler.freedesktop.org/poppler-data-0.4.12.tar.gz
    CMAKE_ARGS:
      - -DCMAKE_INSTALL_PREFIX="{{prefix}}
      - -DCMAKE_INSTALL_LIBDIR=lib
      - -DCMAKE_BUILD_TYPE=Release
      - -DCMAKE_FIND_FRAMEWORK=LAST
      - -DCMAKE_VERBOSE_MAKEFILE=ON
      - -Wno-dev
      - -DBUILD_TESTING=OFF
      - -DBUILD_GTK_TESTS=OFF
      - -DENABLE_BOOST=OFF
      - -DENABLE_CMS=lcms2
      - -DENABLE_GLIB=ON
      - -DENABLE_QT5=ON
      - -DENABLE_QT6=OFF
      - -DENABLE_UNSTABLE_API_ABI_HEADERS=ON
      - -DWITH_GObjectIntrospection=ON
    CXXFLAGS: "$CXXFLAGS -std=c++11"
provides:
  - bin/pdfattach
  - bin/pdfdetach
  - bin/pdffonts
  - bin/pdfimages
  - bin/pdfinfo
  - bin/pdfseparate
  - bin/pdfsig
  - bin/pdftocairo
  - bin/pdftohtml
  - bin/pdftoppm
  - bin/pdftops
  - bin/pdftotext
  - bin/pdfunite
test:
  dependencies:
    freedesktop.org/pkg-config: '*'
  script:
    - pdfinfo lorem.pdf | grep "Lorem Ipsum"
    - pkg-config --modversion poppler-qt5 | grep "{{version}}"
