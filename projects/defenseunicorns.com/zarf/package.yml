distributable:
  url: https://codeload.github.com/defenseunicorns/zarf/tar.gz/refs/tags/v{{version}}
  strip-components: 1

display-name: zarf

versions:
  github: defenseunicorns/zarf

build:
  dependencies:
    go.dev: '*'
  env:
    darwin/aarch64: {PLATFORM: mac-apple}
    darwin/x86-64:  {PLATFORM: mac-intel}
    linux/aarch64:  {PLATFORM: linux-arm}
    linux/x86-64:   {PLATFORM: linux-amd}
  script: |
    make CLI_VERSION=v{{version}} build-cli-${PLATFORM}

    mkdir -p {{prefix}}/bin

    if test "{{hw.platform}}+{{hw.arch}}" = "darwin+aarch64"; then
      mv build/zarf-mac-apple {{prefix}}/bin/zarf
    elif test "{{hw.platform}}+{{hw.arch}}" = "darwin+x86-64"; then
      mv build/zarf-mac-intel {{prefix}}/bin/zarf
    elif test "{{hw.platform}}+{{hw.arch}}" = "linux+aarch64"; then
      mv build/zarf-arm {{prefix}}/bin/zarf
    elif test "{{hw.platform}}+{{hw.arch}}" = "linux+x86-64"; then
      mv build/zarf {{prefix}}/bin/zarf
    fi
    rmdir build
    chmod +x {{prefix}}/bin/zarf

  # zarf is a static binary, so we don't need to patchelf it
  skip: fix-patchelf

provides:
  - bin/zarf

test: test "$(zarf version)" = "v{{version}}"
