distributable:
  url: https://ftp.gnu.org/gnu/gettext/gettext-{{version.raw}}.tar.gz
  strip-components: 1

dependencies:
  gnome.org/libxml2: ~2.13 # 2.14 changes the API
  #TODO ncurses
  tukaani.org/xz: 5 # autopoint needs this to unpack archives

versions:
  github: autotools-mirror/gettext/tags

build:
  dependencies:
    darwin:
      gnu.org/libiconv: "*" # as of v1.0.0
  script:
    # try to prevent iconv contamination on darwin
    - run:
        - cp -a {{deps.gnu.org/libiconv.prefix}}/include .
        - mkdir -p lib
        - cp {{deps.gnu.org/libiconv.prefix}}/lib/*.a lib/
      if: darwin
      working-directory: iconv-static

    - ./configure $ARGS

    # skip docs/examples as bloat
    - run:
        - cat $PROP >gettext-runtime/doc/Makefile
        - cat $PROP >gettext-tools/doc/Makefile
        - cat $PROP >gettext-tools/examples/Makefile
      prop: "all install:"

    - make --jobs {{ hw.concurrency }} $MAKE_ARGS
    - make install

    - run: sed -i 's|{{prefix}}|"$(cd "$(dirname "$0")/.." \&\& pwd)"|' gettextize autopoint
      working-directory: ${{prefix}}/bin
    - run: find . -name \*.la -exec rm -f {} \;
      working-directory: ${{prefix}}/lib

    # ensure we haven't created a dynamic dependency on gnu's libiconv
    - run:
        - otool -L libintl.dylib *.dylib | (grep libiconv.dylib || true) | tee out
        # make sure there's no results
        - test -f out && ! test -s out
      if: darwin
      working-directory: ${{prefix}}/lib
  env:
    ARGS:
      - --prefix={{ prefix }}
      - --disable-debug
      - --with-included-debug
      - --with-included-libcroco
      - --with-included-libunistring
      - --without-included-libxml
      - --disable-java
      - --disable-csharp
    darwin:
      ARGS:
        - --with-libiconv-prefix=$SRCROOT/iconv-static

test: gettext test

provides:
  - bin/autopoint
  - bin/envsubst
  - bin/gettext
  - bin/gettext.sh
  - bin/gettextize
  - bin/msgattrib
  - bin/msgcat
  - bin/msgcmp
  - bin/msgcomm
  - bin/msgconv
  - bin/msgen
  - bin/msgexec
  - bin/msgfilter
  - bin/msgfmt
  - bin/msggrep
  - bin/msginit
  - bin/msgmerge
  - bin/msgunfmt
  - bin/msguniq
  - bin/ngettext
  - bin/recode-sr-latin
  - bin/xgettext
