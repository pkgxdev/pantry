distributable:
  url: https://github.com/facebookexperimental/edencommon/archive/v{{version.raw}}.tar.gz
  strip-components: 1

versions:
  github: facebookexperimental/edencommon/tags

dependencies:
  facebook.com/folly: ~2023.7.24.0
  gflags.github.io: '*'
  google.com/glog: '*'
  openssl.org: =1.1.1u
  boost.org: ~1.82.0
build:
  dependencies:
    cmake.org: '*'
    google.com/googletest: ^1.13
    gnu.org/wget: '*'
    gnu.org/patch: '*'
    darwin:
      llvm.org: '*'
    linux:
      tea.xyz/gx/cc: c99
      tea.xyz/gx/make: '*'

  script:
    - wget -O patchfile.patch 'https://github.com/facebookexperimental/edencommon/commit/b162c1b8d94b4ed49835da6d03b4d0a550082b47.patch?full_index=1' && patch -p1 < patchfile.patch
    - cmake -S . -B _build $ARGS
    - cmake --build _build
    - cmake --install _build
  env:
    linux:
      ARGS:
        - -DCMAKE_C_COMPILER={{deps.tea.xyz/gx/cc.prefix}}/bin/clang
        - -DCMAKE_CXX_COMPILER={{deps.tea.xyz/gx/cc.prefix}}/bin/c++
    ARGS:
      - -DBUILD_SHARED_LIBS=ON
      - -DCMAKE_INSTALL_PREFIX={{prefix}}
      - -DCMAKE_BUILD_TYPE=Release
      - -DCMAKE_VERBOSE_MAKEFILE=ON
      - -Wno-dev
      - -DCMAKE_CXX_FLAGS=-fPIC

test:
  dependencies:
    tea.xyz/gx/cc: c99
  script: |
    g++ -std=c++17 test.cc -o test -ledencommon_utils -lfolly
    ./test | grep 'test'