distributable:
  url: https://github.com/facebook/mvfst/archive/v{{version.raw}}.tar.gz
  strip-components: 1
versions:
  github: facebook/mvfst/tags
dependencies:
  boost.org: '*'
  github.com/facebookincubator/fizz: '*'
  fmt.dev: '*'
  facebook.com/folly: '*'
  gflags.github.io: '*'
  google.com/glog: '*'
  openssl.org: '*'
  linux:
    libsodium.org: ^1.0.19
build:
  dependencies:
    cmake.org: '*'
    linux:
      gnu.org/gcc: '*'
      gnu.org/make: '*'
  script:
    # FIXME: seems unable to find XDP_USE_NEED_WAKEUP in the linux kernel headers...
    # https://github.com/torvalds/linux/blob/54be6c6c5ae8e0d93a6c4641cb7528eb0b6ba478/include/uapi/linux/if_xdp.h#L27
    # revert that commit, and the one that depends on it
    - run: |
        curl https://github.com/facebook/mvfst/commit/3eb7c16af64af5356fd0eec77449fe0e2cf2fd8a.patch | patch -Rp1
        curl https://github.com/facebook/mvfst/commit/ea57a18ce6758afe7cc556cbb74f669fbc913915.patch | patch -Rp1
        curl https://github.com/facebook/mvfst/commit/c6032bb3bdd8b892fb80c05f2854b090cfa91de5.patch | patch -Rp1
      if: '>=2024.1.29'
    - cmake -S . -B _build $CMAKE_ARGS
    - cmake --build _build
    - cmake --install _build
  env:
    CMAKE_ARGS:
      - -DCMAKE_INSTALL_PREFIX="{{prefix}}
      - -DCMAKE_INSTALL_LIBDIR=lib
      - -DCMAKE_BUILD_TYPE=Release
      - -DCMAKE_FIND_FRAMEWORK=LAST
      - -DCMAKE_VERBOSE_MAKEFILE=ON
      - -Wno-dev
      - -DBUILD_TESTING=OFF
      - -DBUILD_TESTS=OFF
      - -DCMAKE_POSITION_INDEPENDENT_CODE=ON
test:
  dependencies:
    google.com/googletest: '*'
    cmake.org: '*'
    gnu.org/gawk: '*'
    linux:
      gnu.org/gcc: '*'
      gnu.org/make: '*'
      curl.se: '*'
  script:
    - PADDED_VERSION=$(echo "{{version}}" | gawk -F. '{printf "%04d.%02d.%02d.%02d\n", $1, $2, $3, $4}')
    - curl -L "https://github.com/facebook/mvfst/archive/v$PADDED_VERSION.tar.gz" | tar -xz --strip-components=1

    # FIXME:FIXME: we should have a test that doesn't involve rebuilding this whole tree

    # FIXME: seems unable to find XDP_USE_NEED_WAKEUP in the linux kernel headers...
    # https://github.com/torvalds/linux/blob/54be6c6c5ae8e0d93a6c4641cb7528eb0b6ba478/include/uapi/linux/if_xdp.h#L27
    # revert that commit, and the one that depends on it
    - run: |
        curl https://github.com/facebook/mvfst/commit/3eb7c16af64af5356fd0eec77449fe0e2cf2fd8a.patch | patch -Rp1
        curl https://github.com/facebook/mvfst/commit/ea57a18ce6758afe7cc556cbb74f669fbc913915.patch | patch -Rp1
        curl https://github.com/facebook/mvfst/commit/c6032bb3bdd8b892fb80c05f2854b090cfa91de5.patch | patch -Rp1
      if: '>=2024.1.29'

    - cmake . $CMAKE_ARGS
    - cmake --build .

      # Function to check if the port is free
    - |
      is_port_free() {
          local port_to_check=$1
          (echo >/dev/tcp/127.0.0.1/$port_to_check) &>/dev/null
      }
    # Start checking ports with 7000
    - current_port=7000
    # Find a free port
    - |
      while is_port_free $current_port; do
          ((current_port++))
      done
    - ./echo --mode server --host 127.0.0.1 --port $current_port &
    - sleep 15
    - ./echo --mode client --host 127.0.0.1 --port $current_port &
    - sleep 15
    - killall echo || true
  env:
    CMAKE_ARGS:
      - -DCMAKE_INSTALL_PREFIX="{{prefix}}
      - -DCMAKE_INSTALL_LIBDIR=lib
      - -DCMAKE_BUILD_TYPE=Release
      - -DCMAKE_FIND_FRAMEWORK=LAST
      - -DCMAKE_VERBOSE_MAKEFILE=ON
      - -Wno-dev
      - -DBUILD_TESTING=OFF
