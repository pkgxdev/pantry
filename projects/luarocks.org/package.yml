distributable:
  url: https://luarocks.org/releases/luarocks-{{version}}.tar.gz
  strip-components: 1

versions:
  url: https://luarocks.org/releases/
  match: /luarocks-\d+\.\d+\.\d+\.tar\.gz/
  strip:
    - /^luarocks-/
    - /\.tar\.gz$/

dependencies:
  lua.org: '*'
  info-zip.org/unzip: '*'

runtime:
  env:
    LUAROCKS_ROOT: "{{prefix}}"
    LUA_ROOT: "{{deps.lua.org.prefix}}"

build:
  dependencies:
    tea.xyz/gx/cc: c99
    tea.xyz/gx/make: '*'
  script:
    - ./configure $ARGS
    - make --jobs {{ hw.concurrency }} install
    - find '{{prefix}}/etc/luarocks/' -name 'config-*.lua' -execdir sed -i '' -e 's|{{prefix}}|${LUAROCKS_ROOT}|g' {} +
    - find '{{prefix}}/bin/' -name 'luarocks' -execdir sed -i '' -e 's|{{prefix}}|${LUAROCKS_ROOT}|g' {} +
    - find '{{prefix}}/bin/' -name 'luarocks-admin' -execdir sed -i '' -e 's|{{prefix}}|${LUAROCKS_ROOT}|g' {} +
    - find '{{prefix}}/etc/luarocks/' -name 'config-*.lua' -execdir sed -i '' -e 's|{{deps.lua.org.prefix}}|${LUA_ROOT}|g' {} +
  env:
    ARGS:
      - --prefix="{{prefix}}"
      - --sysconfdir="{{prefix}}/etc"
      - --rocks-tree="{{prefix}}"
      - --force-config
      - --disable-incdir-check

provides:
  - bin/luarocks
  - bin/luarocks-admin

test: luarocks --version | grep {{version}}