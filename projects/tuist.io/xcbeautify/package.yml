distributable:
  url: https://github.com/tuist/xcbeautify/archive/refs/tags/{{version}}.tar.gz
  strip-components: 1

versions:
  github: tuist/xcbeautify

platforms:
  - darwin

provides:
  - bin/xcbeautify

build:
  # dependencies:
  #   swift.org: 5
  #   apple.com/xcode: >=13.3
  script:
    # swift freaks all the way out if there's UTF-8 in the `TMPDIR`
    # swift build --configuration=release
    # TSCUtility/Triple.swift:215: Fatal error: Failed to parse target info (malformed).
    - export TMPDIR=$(mktemp -d)

    # 0.21.0 doesn't have its version bumped
    - run: echo 'let version = "{{version}}"' > Sources/xcbeautify/Version.swift
      if: '>=0.21.0'

    # match out swift tools version with our installed swift
    - run:
        - SWIFT_VERSION="$(swift --version | head -n1 | sed -E 's/.*Swift version ([0-9]+\.[0-9]+).*/\1/')"
        - 'sed -i "s/swift-tools-version:.*/swift-tools-version:$SWIFT_VERSION/" Package.swift'
        # the enableUpcomingFeature errors because it's already available.
        - sed -i 's|\(.*StrictConcurrency\)|//\1|' Package.swift
      if: darwin # lol

    - make install
  env:
    PREFIX: '{{prefix}}'

test:
  # v3 doesn't support macOS 13
  - run: |
      if test "{{version.major}}" -ge 3 && test "$(sw_vers -productVersion | cut -d . -f 1)" -lt 14; then
        exit 0
      fi
    if: darwin
  - xcbeautify --version | grep {{version}}
