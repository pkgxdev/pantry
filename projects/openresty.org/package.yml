distributable:
  url: https://github.com/openresty/openresty/archive/refs/tags/v{{ version }}.tar.gz
  strip-components: 1

provides:
  - bin/openresty

versions:
  github: openresty/openresty
  strip: /v/

build:
  dependencies:
    gnu.org/make: ^4
    gnu.org/gcc: '*'
    perl.org: '*'
    waterlan.home.xs4all.nl/dos2unix: '*'
    mercurial-scm.org: '*'
    git-scm.org: '*'
    gnu.org/wget: '*'

    pcre.org: '8.45' #v2?
    openssl.org: '^1.1.1k'
    zlib.net: '^1.2.13'
  script:
    # Step 1: Rebuild the tar-ball (https://github.com/openresty/openresty?tab=readme-ov-file#for-bundle-maintainers)
    - run: |
        make
    # Step 2: Building OpenResty (https://openresty.org/en/installation.html#building-from-source)
    - run: |
        cd openresty-{{version}}
        ./configure -j{{ hw.concurrency }} --prefix={{ prefix }}
        make -j{{ hw.concurrency }}
        make install
  env:
    PREFIX: '{{ prefix }}'

test:
  script:
    - openresty -v
    # - test "$(openresty --version)" = "openresty {{version}}"
