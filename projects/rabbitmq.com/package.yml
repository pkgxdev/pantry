distributable:
  url: https://github.com/rabbitmq/rabbitmq-server/releases/download/v{{version}}/rabbitmq-server-generic-unix-{{version}}.tar.xz
  strip-components: 1
versions:
  github: rabbitmq/rabbitmq-server
warnings:
  - vendored
dependencies:
  erlang.org: '*'
build:
  dependencies:
    python.org: ~3.11
  script:
    - run: |
        cp -r $SRCROOT/* ./
        rm -r *.pkgx.*
        rm pkgx.yaml
      working-directory: "{{prefix}}"
    - run: mkdir -p lib/rabbitmq og/rabbitmq
      working-directory: "{{prefix}}/var"
provides:
  - sbin/rabbitmqctl
  - sbin/rabbitmq-defaults
  - sbin/rabbitmq-diagnostics
  - sbin/rabbitmq-env
  - sbin/rabbitmq-plugins
  - sbin/rabbitmq-queues
  - sbin/rabbitmq-server
  - sbin/rabbitmq-streams
  - sbin/rabbitmq-upgrade
  - sbin/vmware-rabbitmq
test:
  env:
    RABBITMQ_MNESIA_BASE: $PWD/var/lib/rabbitmq/mnesia
  script:
    - rabbitmqctl --version | grep {{version}}
    - rabbitmq-server -detached && sleep 15
    # Let's give the server 15 seconds to start
    - rabbitmqctl status | grep "Virtual host count"
    - rabbitmqctl stop | grep "Stopping and halting node"
