distributable:
  url: https://github.com/rabbitmq/rabbitmq-server/releases/download/v{{version}}/rabbitmq-server-generic-unix-{{version}}.tar.xz
  strip-components: 1
versions:
  github: rabbitmq/rabbitmq-server
dependencies:
  erlang.org: '*'
build:
  dependencies:
    python.org: ~3.11
  script:
    - run: |
        cp -r $SRCROOT/* ./
        rm -r *.pkgx.*
        rm pkgx.yaml
      working-directory: "{{prefix}}"
    - run: mkdir -p lib/rabbitmq og/rabbitmq
      working-directory: "{{prefix}}/var"
    - run: |
        ln -s ../sbin/rabbitmqctl rabbitmqctl || true
        ln -s ../sbin/rabbitmq-defaults rabbitmq-defaults || true
        ln -s ../sbin/rabbitmq-diagnostics rabbitmq-diagnostics || true
        ln -s ../sbin/rabbitmq-env rabbitmq-env || true
        ln -s ../sbin/rabbitmq-plugins rabbitmq-plugins || true
        ln -s ../sbin/rabbitmq-queues rabbitmq-queues || true
        ln -s ../sbin/rabbitmq-server rabbitmq-server || true
        ln -s ../sbin/rabbitmq-streams rabbitmq-streams || true
        ln -s ../sbin/rabbitmq-upgrade rabbitmq-upgrade || true
        ln -s ../sbin/vmware-rabbitmq vmware-rabbitmq || true
      working-directory: "{{prefix}}/bin"
provides:
  - bin/rabbitmqctl
  - bin/rabbitmq-diagnostics
test:
  env:
    RABBITMQ_MNESIA_BASE: $PWD/var/lib/rabbitmq/mnesia
  script:
    - rabbitmqctl --version | grep {{version}}
    - rabbitmq-server -detached && sleep 15
    # Let's give the server 15 seconds to start
    - rabbitmqctl status | grep "Virtual host count"
    - rabbitmqctl stop | grep "Stopping and halting node"
