distributable:
  url: git+https://github.com/smallstep/cli
  ref: v{{version}}

versions:
  github: smallstep/cli/tags
  strip: /^v/

provides:
  - bin/step


build:
  dependencies:
    go.dev: ^1.22
  script:
    go build $ARGS -ldflags="$LDFLAGS" ./cmd/step
  env:
    darwin/aarch64: {PLATFORM: darwin_arm64, GOARCH: arm64, GOOS: darwin}
    darwin/x86-64:  {PLATFORM: darwin_amd64_v1, GOARCH: amd64, GOOS: darwin}
    linux/aarch64:  {PLATFORM: linux_arm64, GOARCH: arm64, GOOS: linux}
    linux/x86-64:   {PLATFORM: linux_amd64_v1, GOARCH: amd64, GOOS: linux}
    COMMIT: $(git describe --always --abbrev=8 --dirty)
    DATE: $(date -u +%FT%TZ)
    ARGS:
      - -trimpath
      - -o={{prefix}}/bin/syft
    linux:
      ARGS:
        - -buildmode=pie
    LDFLAGS:
      - -s
      - -w
      - -X main.version={{version}}
      - -X main.gitCommit=${COMMIT}
      - -X main.buildDate=${DATE}


test:
  script:
    - step version | grep -q {{version}}
