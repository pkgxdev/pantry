distributable:
  url: https://github.com/macvim-dev/macvim/archive/release-{{version.major}}.tar.gz
  strip-components: 1
versions:
  github: macvim-dev/macvim/tags
  match: /release-\d+/
  strip:
    - /^release-/
platforms:
  - darwin
dependencies:
  cscope.sourceforge.io: '*'
  lua.org: '*'
  python.org: ^3.11
  ruby-lang.org: '*'
runtime:
  env:
    PYTHONHOME: "{{deps.python.org.prefix}}"
build:
  dependencies:
    tea.xyz/gx/cc: c99
    gnu.org/make: '*'
    gnu.org/gettext: '*'
    libsodium.org: '*'
  script:
    - ./configure $ARGS
    - make --jobs {{ hw.concurrency }}
    - mkdir -p {{prefix}}/bin
    - mv -f ./src/MacVim/build/Release/MacVim.app {{prefix}}/MacVim.app
    - run: |
        ln -s ../MacVim.app/Contents/bin/gview gview
        ln -s ../MacVim.app/Contents/bin/gvim gvim
        ln -s ../MacVim.app/Contents/bin/gvimdiff gvimdiff
        ln -s ../MacVim.app/Contents/bin/gvimtutor gvimtutor
        ln -s ../MacVim.app/Contents/bin/mview mview
        ln -s ../MacVim.app/Contents/bin/mvim mvim
        ln -s ../MacVim.app/Contents/bin/mvimdiff mvimdiff
        ln -s ../MacVim.app/Contents/bin/mvimtutor mvimtutor
        ln -s ../MacVim.app/Contents/bin/view view
        ln -s ../MacVim.app/Contents/bin/vim vim
        ln -s ../MacVim.app/Contents/bin/vimdiff vimdiff
        ln -s ../MacVim.app/Contents/bin/vimtutor vimtutor
      working-directory: "{{prefix}}/bin"
  env:
    CC: "{{deps.tea.xyz/gx/cc.prefix}}/bin/clang"
    ARGS:
      - --with-features=huge
      - --enable-multibyte
      - --enable-perlinterp
      - --enable-rubyinterp
      - --enable-tclinterp
      - --enable-terminal
      - --without-x
      - --with-compiledby=tea.xyz
      - --without-local-dir
      - --enable-cscope
      - --enable-luainterp
      - --with-lua-prefix={{deps.lua.org.prefix}}
      - --enable-luainterp
      - --enable-python3interp
      - --disable-sparkle
      - --disable-gpm
      - --disable-canberra
      - --enable-fail-if-missing
      - --with-macarchs=$(uname -m)
      - --with-tlib=ncurses
      - --enable-static
      - --disable-shared
provides:
  - bin/gview
  - bin/gvim
  - bin/gvimdiff
  - bin/gvimtutor
  - bin/mview
  - bin/mvim
  - bin/mvimdiff
  - bin/mvimtutor
  - bin/view
  - bin/vim
  - bin/vimdiff
  - bin/vimtutor
test:
  script:
    - mvim --version | grep VIM
    - mvim -v -T dump  -s commands.vim test.txt <<< $'\n'
    - cat test.txt | grep "hello python3"
