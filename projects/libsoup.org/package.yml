distributable:
  url: https://download.gnome.org/sources/libsoup/{{version.marketing}}/libsoup-{{version}}.tar.xz
  strip-components: 1

versions:
  url: https://download.gnome.org/sources/libsoup/cache.json
  match: /libsoup-\d+\.\d+\.\d+\.tar\.xz/
  strip:
    - /^libsoup-/
    - /\.tar\.xz/

dependencies:
  gnome.org/glib-networking: "*"
  gnutls.org: "*"
  rockdaboot.github.io/libpsl: "*"
  kerberos.org: "*"
  gnome.org/libxml2: "*"
  sqlite.org: "*"
  nghttp2.org: "*"
  linux:
    gnu.org/gettext: "*"
    gnome.org/glib: "*"
    github.com/google/brotli: "*"

build:
  dependencies:
    gnome.org/gobject-introspection: "*"
    mesonbuild.com: "*"
    ninja-build.org: "*"
    freedesktop.org/pkg-config: "*"
    python.org: ~3.11
    gnome.org/vala: "*"
    nixos.org/patchelf: "*"
  script:
    - meson setup build $MESON_ARGS
    - meson compile -C build --verbose
    - meson install -C build
    - run: |
        DIRS=$(find . -mindepth 1 -maxdepth 1 -type d -name libsoup\*)
        for d in $DIRS; do
          d2=$(echo $d | sed -r 's/\.\/(libsoup.*)-[0-9]+\.[0-9]+$/\1/')
          ln -s $d $d2
        done
      working-directory: "{{prefix}}/include"
    # TODO: I still don't know why libsqlite3.so doesn't link right.
    - run: patchelf --replace-needed {{deps.sqlite.org.prefix}}/lib/libsqlite3.so libsqlite3.so libsoup-*.so
      working-directory: "{{prefix}}/lib"
      if: linux
  env:
    MESON_ARGS:
      - --prefix="{{prefix}}"
      - --libdir="{{prefix}}/lib"
      - --buildtype=release
      - --wrap-mode=nofallback
    linux:
      CC: clang
      CXX: clang++
      LD: clang

test:
  dependencies:
    freedesktop.org/pkg-config: "*"
    nixos.org/patchelf: "*"
  script:
    - run: cc test.c $(pkg-config --libs --cflags libsoup-3.0 sqlite3) -o test
      if: ">=3.6.6"
    - run: cc test.c $(pkg-config --libs --cflags libsoup-3.0) -o test
      if: ">=2.90<3.6.6"
    - run: cc test.c $(pkg-config --libs --cflags libsoup-2.4) -o test
      if: "<2.90"
    - run: ldd test
      if: linux
    - ./test
