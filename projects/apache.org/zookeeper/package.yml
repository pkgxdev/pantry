# distributable:
#   url: https://archive.apache.org/dist/zookeeper/zookeeper-{{version}}/apache-zookeeper-{{version}}.tar.gz
#   strip-components: 1
versions:
  url: https://archive.apache.org/dist/zookeeper/
  match: /zookeeper-\d+\.\d+\.\d+/
  strip:
    - /^zookeeper-/
dependencies:
  openjdk.org: '*'
  openssl.org: '*'
build:
  dependencies:
    gnu.org/autoconf: '*'
    gnu.org/automake: '*'
    freedesktop.org/cppunit: '*'
    gnu.org/libtool: '*'
    maven.apache.org: '*'
    freedesktop.org/pkg-config: '*'
    curl.se: '*'
    linux:
      gnu.org/gcc: '*'
  # Malformed input or input contains unmappable characters: ~/pantry/builds/apache.org???zookeeper-3.9.1+linux
  working-directory: ../zookeeper
  script:
    - curl -L "https://archive.apache.org/dist/zookeeper/zookeeper-{{version}}/apache-zookeeper-{{version}}.tar.gz" | tar -xz --strip-components=1
    - run: mkdir -p libexec etc/zookeeper var/log/zookeeper var/run/zookeeper/data
      working-directory: "{{prefix}}"
    - mvn install -Pfull-build -DskipTests
    - tar -xf zookeeper-assembly/target/apache-zookeeper-{{version}}-bin.tar.gz
    - run: |
        rm -f bin/*.cmd
        cp -r ./* {{prefix}}/libexec/
      working-directory: apache-zookeeper-{{version}}-bin
    - tar -xf zookeeper-assembly/target/apache-zookeeper-{{version}}-lib.tar.gz
    - run: |
        cp -r usr/include {{prefix}}/
        cp -r usr/lib {{prefix}}/
      working-directory: apache-zookeeper-{{version}}-lib
    - run: |
        ln -s ../libexec/bin/zkCleanup.sh zkCleanup
        ln -s ../libexec/bin/zkCli.sh zkCli
        ln -s ../libexec/bin/zkEnv.sh zkEnv
        ln -s ../libexec/bin/zkServer-initialize.sh zkServer-initialize
        ln -s ../libexec/bin/zkServer.sh zkServer
        ln -s ../libexec/bin/zkSnapshotComparer.sh zkSnapshotComparer
        ln -s ../libexec/bin/zkSnapshotRecursiveSummaryToolkit.sh zkSnapshotRecursiveSummaryToolkit
        ln -s ../libexec/bin/zkSnapShotToolkit.sh zkSnapShotToolkit
        ln -s ../libexec/bin/zkTxnLogToolkit.sh zkTxnLogToolkit
      working-directory: "{{prefix}}/bin"
    - run: |
        ln -s bin/zkCleanup.sh zkCleanup.sh
        ln -s bin/zkCli.sh zkCli.sh
        ln -s bin/zkEnv.sh zkEnv.sh
        ln -s bin/zkServer-initialize.sh zkServer-initialize.sh
        ln -s bin/zkServer.sh zkServer.sh
        ln -s bin/zkSnapshotComparer.sh zkSnapshotComparer.sh
        ln -s bin/zkSnapshotRecursiveSummaryToolkit.sh zkSnapshotRecursiveSummaryToolkit.sh
        ln -s bin/zkSnapShotToolkit.sh zkSnapShotToolkit.sh
        ln -s bin/zkTxnLogToolkit.sh zkTxnLogToolkit.sh
      working-directory: "{{prefix}}/libexec"
provides:
  - bin/zkCleanup
  - bin/zkCli
  - bin/zkEnv
  - bin/zkServer-initialize
  - bin/zkServer
  - bin/zkSnapshotComparer
  - bin/zkSnapshotRecursiveSummaryToolkit
  - bin/zkSnapShotToolkit
  - bin/zkTxnLogToolkit
test:
  script:
    - mkdir cfg
    - export ZOOCFGDIR=$PWD/cfg
    - run: |
        cat << EOF>cfg/zoo.cfg
        tickTime=2000
        initLimit=10
        syncLimit=5
        dataDir=$PWD/data
        clientPort=2181
        EOF
    - zkServer start
    - zkServer status
    - zkServer stop