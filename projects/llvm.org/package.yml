distributable:
  url: https://github.com/llvm/llvm-project/releases/download/llvmorg-{{ version }}/llvm-project-{{ version }}.src.tar.xz
  strip-components: 1

versions:
  github: llvm/llvm-project
  strip: /^llvmorg-/

provides:
  - bin/lld
  - bin/clang
  - bin/clang++

dependencies:
  zlib.net: 1
  darwin:
    apple.com/xcode/clt: '*'

build:
  dependencies:
    tea.xyz/gx/cc: c99
    cmake.org: 3
    ninja-build.org: 1
    python.org: 3
    crates.io/semverator: '*'
  working-directory: build
  script:
    # Building compiler-rt on darwin+aarch64 fails for versions less than
    # 14 with the below configuration. FIXME if possible, of course.
    - run: |
        if test "{{hw.platform}}" = "linux" || \
           test "{{hw.arch}}" = "x86-64" || \
           semverator satisies '>=14'; then
             ARGS="$ARGS -DLLVM_ENABLE_RUNTIMES='compiler-rt'"
        fi
    - cmake ../llvm -G Ninja $ARGS
    - ninja
    - ninja install
  receipt:
    - LLVMConfig.cmake
  env:
    ARGS:
      - -DCMAKE_INSTALL_PREFIX="{{ prefix }}"
      - -DCMAKE_BUILD_TYPE=Release
      - -DLLVM_ENABLE_PROJECTS='lld;clang'
      - -DLLVM_INCLUDE_DOCS=OFF
      - -DLLVM_INCLUDE_TESTS=OFF
      - -DLLVM_LINK_LLVM_DYLIB=ON
    darwin:
      ARGS:
      #FIXME shouldnâ€™t *have to* require the command line tools package
      #FIXME this is no good for systems with only Xcode installed
      #NOTE how do Apple make their LLVM find both? we want the same trick
      - -DDEFAULT_SYSROOT=/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk

test:
  fixture: |
    #include <stdio.h>
    int main() {
      printf("Hello World!\n");
      return 0;
    }
  dependencies:
    crates.io/semverator: '*'
  script:
    # Building compiler-rt on darwin+aarch64 fails for versions less than
    # 14 with the below configuration. FIXME if possible, of course.
    - run: |
        if test "{{hw.platform}}" = "linux" || \
           test "{{hw.arch}}" = "x86-64" || \
           semverator satisies '>=14'; then
             ARGS="$ARGS -fsanitize=address,undefined"
        fi
    - mv $FIXTURE $FIXTURE.c
    - clang $ARGS $FIXTURE.c
    - ./a.out
  env:
    ARGS:
      - -Wl,-rpath,$TEA_PREFIX
