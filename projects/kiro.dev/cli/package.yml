# because of the license we cannot redistribute the binary, so we provide a
# shim that will download the binary on first execution and then execute it
#
# license: https://aws.amazon.com/pt/legal/aws-ip-license-terms/

versions:
  url: https://desktop-release.q.us-east-1.amazonaws.com/latest/manifest.json
  match: /"version":\s*"\d+\.\d+\.\d+"/
  strip:
    - /^"version":\s*"/
    - /"$/

dependencies:
  curl.se: "*"

build:
  - sed -i "s/%%version%%/{{version}}/g" props/shim.{{hw.platform}}
  - install -Dm755 props/shim.{{hw.platform}} {{prefix}}/bin/kiro-cli
  - install -Dm755 props/shim.{{hw.platform}} {{prefix}}/bin/kiro-cli-chat
  - install -Dm755 props/shim.{{hw.platform}} {{prefix}}/bin/kiro-cli-term

provides:
  - bin/kiro-cli
  - bin/kiro-cli-chat
  - bin/kiro-cli-term

test:
  dependencies:
    gnu.org/coreutils: "*"
  script:
  # first time will download and execute the actual binary
  - kiro-cli --version | tee /dev/stderr | grep -qw "{{version}}"
  # second time will just execute the actual binary
  - timeout 0.5 kiro-cli --version | tee /dev/stderr | grep -qw "{{version}}"
  # check the other binaries too
  - kiro-cli-chat --version | tee /dev/stderr | grep -qw "{{version}}"
  - kiro-cli-term --version | tee /dev/stderr | grep -qw "{{version}}"
  # this will fail if kiro-cli cannot find kiro-cli-chat
  - kiro-cli chat --help >/dev/null
