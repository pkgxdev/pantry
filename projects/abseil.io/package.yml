distributable:
  url: https://github.com/abseil/abseil-cpp/archive/refs/tags/{{version.tag}}.tar.gz
  strip-components: 1

versions:
  github: abseil/abseil-cpp

build:
  dependencies:
    cmake.org: ^3
    linux:
      gnu.org/gcc: ^14 # since 20250814.0
  script:
    - cmake -S . -B build $CMAKE_ARGS
    - cmake --build build
    - cmake --install build

      # Remove bad flags in .pc files.
      # https://github.com/abseil/abseil-cpp/issues/1408
    - run: sed -i 's/-Xarch_x86_64 -Xarch_x86_64 -Xarch_arm64 //g' *.pc
      working-directory: ${{ prefix }}/lib/pkgconfig
      if: darwin

    - run: sed -i
        -e "s:{{ pkgx.prefix }}:\$\{CMAKE_CURRENT_LIST_DIR\}/../../../../..:g"
        -e "s/\+brewing//g"
        abslTargets{,-release}.cmake
      working-directory: '{{prefix}}/lib/cmake/absl'
  env:
    CMAKE_ARGS:
      - -DCMAKE_CXX_STANDARD=17
      - -DBUILD_SHARED_LIBS=ON
      - -DCMAKE_INSTALL_RPATH={{ prefix }}/lib
      - -DCMAKE_BINARY_DIR={{ prefix }}/bin
      - -DABSL_PROPAGATE_CXX_STD=ON
      - -DCMAKE_INSTALL_PREFIX={{ prefix }}
      - -DCMAKE_INSTALL_LIBDIR={{ prefix }}/lib
      - -DCMAKE_BUILD_TYPE=Release
      - -DCMAKE_FIND_FRAMEWORK=LAST
      - -DCMAKE_VERBOSE_MAKEFILE=ON
      - -Wno-dev
      - -DBUILD_TESTING=OFF

test:
  dependencies:
    freedesktop.org/pkg-config: ^0
  script:
    - c++ -std=c++17 test.cc $(pkg-config --cflags --libs absl_strings)
    - 'test "$(./a.out)" = "Joined string: foo-bar-baz\n"'
