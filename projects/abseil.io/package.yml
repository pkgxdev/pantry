distributable:
  url: https://github.com/abseil/abseil-cpp/archive/refs/tags/{{version.raw}}.tar.gz
  strip-components: 1

versions:
  github: abseil/abseil-cpp/releases/tags

build:
  dependencies:
    cmake.org: ^3
    tea.xyz/gx/cc: c99
    tea.xyz/gx/make: '*'

  script: |
    cmake -S . -B build $ARGS
    cmake --build build
    cmake --install build

    # Remove bad flags in .pc files.
    # https://github.com/abseil/abseil-cpp/issues/1408
    if [[ "$(uname)" == "Darwin" ]]; then
      sed -i '' 's/-Xarch_x86_64 -Xarch_x86_64 -Xarch_arm64 //g' {{ prefix }}/lib/pkgconfig/absl_random_internal_randen_hwaes{_impl,}.pc
    fi

    cd "{{prefix}}/lib/cmake/absl"
    sed -i.bak \
        -e "s:$(tea --prefix):\$\{CMAKE_CURRENT_LIST_DIR\}/../../../../..:g" \
        abslTargets{,-release}.cmake
    rm abslTargets{,-release}.cmake.bak

test:
  dependencies:
    tea.xyz/gx/cc: c99
  script: |
    ls -l
    c++ -std=c++17 -I{{ prefix }}/include -L{{ prefix }}/lib -labsl_strings test.cc
    test "$(./a.out)" = "Joined string: foo-bar-baz\n"
