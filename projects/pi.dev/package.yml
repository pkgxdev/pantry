distributable:
  url: https://registry.npmjs.org/@mariozechner/pi-coding-agent/-/pi-coding-agent-{{version}}.tgz
  strip-components: 1

display-name: pi.dev

versions:
  npm: "@mariozechner/pi-coding-agent"

provides:
  - bin/pi
  - bin/pi-init

dependencies:
  nodejs.org: ^20
  github.com/mikefarah/yq: "*"
  stedolan.github.io/jq: "*"
  gnu.org/sed: "*"

build:
  dependencies:
    nodejs.org: ^20
    npmjs.com: "*"
  script:
    - npm i $ARGS .
    - install -Dm755 props/pi-init {{prefix}}/bin/pi-init
  env:
    ARGS:
      - --global
      - --prefix={{prefix}}
      - --install-links
      - --unsafe-perm

test:
  - pi --version | grep -q "{{version}}"
  - run: pi-init --help | grep -q "pi-init"
  - run:
      - export OPENAI_API_KEY="test-key"
      - pi-init $FIXTURE --write-only --output ./settings.json
      - test -f ./settings.json
      - jq -e '.model == "openai/gpt-5"' ./settings.json
      - jq -e '.api_key_env == "OPENAI_API_KEY"' ./settings.json
    fixture:
      extname: md
      content: |
        ---
        agent:
          model: "openai/gpt-5"
        auth:
          provider_api_key_env: "OPENAI_API_KEY"
        runtime:
          workspace: "."
        launch:
          mode: "interactive"
        ---
