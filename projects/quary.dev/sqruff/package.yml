distributable:
  url: https://github.com/quarylabs/sqruff/archive/refs/tags/{{ version.tag }}.tar.gz
  strip-components: 1

versions:
  github: quarylabs/sqruff

build:
  dependencies:
    rust-lang.org/rustup: '*'
  script:
    # requires nightly features
    - mkdir -p $HOME/.cargo/bin
    - export PATH=$HOME/.cargo/bin:$PATH
    - ln -sf {{deps.rust-lang.org/rustup.prefix}}/bin/rustup $HOME/.cargo/bin/rustup
    - rustup default $(grep channel rust-toolchain.toml | sed 's/channel = "//;s/"//')
    - ln -sf $HOME/.rustup/toolchains/*/bin/* $HOME/.cargo/bin/

    - cargo install --locked --path crates/cli --root {{prefix}}

provides:
  - bin/bench
  - bin/sqruff

test:
  - test "$(sqruff -V)" = "sqruff {{version}}"
  - run: sqruff lint $FIXTURE
    fixture:
      extname: sql
      content: SELECT 1;
  - run: if ! sqruff lint $FIXTURE; then true; else false; fi
    fixture:
      extname: sql
      content: |
        SELECT 1
        SELECT 2
