distributable:
  url: https://nodejs.org/dist/v{{ version }}/node-v{{ version }}.tar.xz
  strip-components: 1

versions:
  github: nodejs/node/tags

companions:
  npmjs.com: '*'

dependencies:
  # prior builds of nodejs used our icu4c
  unicode.org: ^71
  openssl.org: 1.1
  zlib.net: 1

provides:
  - bin/node

interprets:
  extensions: js
  args: node

build:
  dependencies:
    # otherwise, we hit https://reviews.llvm.org/D131307
    linux:
      llvm.org: '<16'
      gnu.org/make: '*'
    python.org: ~3.9
    freedesktop.org/pkg-config: ^0.29
  script:
    - run: |
        # https://github.com/pkgxdev/brewkit/issues/319
        PYTHON_VERSION_MAJOR='2'
        pkgx "+python.org^${PYTHON_VERSION_MAJOR}"
        PYTHON_BIN_PATH="$(realpath "{{deps.python.org.prefix}}/../v${PYTHON_VERSION_MAJOR}/bin")"
        PATH_WITHOUT_PYTHON="$(echo "${PATH}" | tr ':' '\n' | grep -v '/python.org/' | tr '\n' ':')"
        export PATH="${PYTHON_BIN_PATH}:${PATH_WITHOUT_PYTHON}"
        python --version 2>&1 | grep "Python ${PYTHON_VERSION_MAJOR}"
        unset PYTHON_VERSION_MAJOR PYTHON_BIN_PATH PATH_WITHOUT_PYTHON
      if: <11
    - ./configure $ARGS
    - make --jobs {{ hw.concurrency }} install
  env:
    ARGS:
      - --without-npm
      - --prefix={{ prefix }}
      - --shared-openssl
      - --shared-zlib
    linux:
      CC: clang
      CXX: clang++
      AS: llvm-as
    linux/x86-64:
      CFLAGS: -fPIC
      CXXFLAGS: -fPIC
      LDFLAGS: -pie

test:
  script: |
    out=$(node $FIXTURE)
    test "$out" = "Hello, world!"
  fixture: console.log("Hello, world!");
