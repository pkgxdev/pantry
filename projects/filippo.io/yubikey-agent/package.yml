distributable:
  url: https://github.com/FiloSottile/yubikey-agent/releases/tag/v{{ version }}
  ref: v{{version}}}

display-name: yubikey-agent

versions:
  github: FiloSottile/yubikey-agent/tags

platforms:
  - darwin
  - linux/x86-64

dependencies:
  pcsclite.apdu.fr: ^2
  linux:
    gnupg.org/pinentry: '*'

build:
  dependencies:
    linux:
      freedesktop.org/pkg-config: '*'
    go.dev: '^1.20'
  script: |
    go build

  env:
    LDFLAGS:
      - "-s -w -X main.Version=v{{ version }}"

provides:
  - bin/yubikey-agent

#############################################
##### NEED TO PORT THIS OVER FROM BREW: #####
#############################################
# https://github.com/Homebrew/homebrew-core/blob/d60bc504f4526917b7aae5cdae51f188edcc7d8e/Formula/y/yubikey-agent.rb#L4
    
# any way to do this with pkgx?
#service:
#    run [opt_bin/"yubikey-agent", "-l", var/"run/yubikey-agent.sock"]
#    keep_alive true
#    log_path var/"log/yubikey-agent.log"
#    error_log_path var/"log/yubikey-agent.log"

#test:
  #script:
    # socket = testpath/"yubikey-agent.sock"
    # fork { exec bin/"yubikey-agent", "-l", socket }
    # sleep 1
    # assert_predicate socket, :exist?
