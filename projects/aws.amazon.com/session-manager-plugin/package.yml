distributable:
  url: https://github.com/aws/session-manager-plugin/archive/{{version}}.tar.gz
  strip-components: 1

display-name: aws/session-manager-plugin

versions:
  github: aws/session-manager-plugin/tags

companions:
  aws.amazon.com/cli: 2

build:
  dependencies:
    go.dev: 1.23
    gnu.org/make: "*"
  script:
    - echo "{{version}}" > VERSION
    - sed -i -e 's/1.2.0.0/{{version.raw}}/g' src/version/version.go
    - make GO_BUILD="go build" build-${PLATFORM}
    - mkdir -p "{{ prefix }}"/bin
    - mv ./bin/${BIN_DIR}/session-manager-plugin "{{prefix}}"/bin/
  env:
    CGO_ENABLED: 0
    darwin/aarch64: { PLATFORM: darwin-arm64, BIN_DIR: darwin_arm64_plugin }
    darwin/x86-64: { PLATFORM: darwin-amd64, BIN_DIR: darwin_amd64_plugin }
    linux/aarch64: { PLATFORM: arm64, BIN_DIR: linux_arm64_plugin }
    linux/x86-64: { PLATFORM: linux-amd64, BIN_DIR: linux_amd64_plugin }

provides:
  - bin/session-manager-plugin

test:
  script:
    - test "$(session-manager-plugin --version)" = {{version}}
    - session-manager-plugin
