distributable:
  url: https://github.com/spider-rs/spider/archive/refs/tags/{{ version.tag }}.tar.gz
  strip-components: 1

provides:
  - bin/spider

versions:
  github: spider-rs/spider

build:
  dependencies:
    rust-lang.org: '>=1.81'
    rust-lang.org/cargo: '*'
  script:
    # needs openssl 3 on linux, but our rust locks us to 1.1.1
    # so we just jam it first in the path vars and pray. PRAY HARD!
    - run:
        - set -a
        - source <(pkgx +openssl^3)
      if: linux
    # this appears to have broken x86-64...
    - run: sed -i 's/tokio-tungstenite = "0.26"/tokio-tungstenite = "0.24"/' Cargo.toml
      working-directory: spider_chrome
      if: linux/x86-64
    - cargo install --locked --path spider_cli --root {{prefix}} --features smart
  env:
    linux:
      # since we are tricking _ourselves_ into using openssl 3, we need to
      # link it statically.
      OPENSSL_STATIC: 1

test: spider -v --url https://choosealicense.com scrape
