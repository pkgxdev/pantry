distributable:
  url: https://github.com/topgrade-rs/topgrade/archive/refs/tags/v{{ version }}.tar.gz
  strip-components: 1

provides:
  - bin/topgrade

versions:
  github: topgrade-rs/topgrade

build:
  dependencies:
    rust-lang.org: '>=1.56'
    rust-lang.org/cargo: '*'
  script: cargo install --locked --path . --root {{prefix}}

test:
  # prevents an unskippable prompt
  - run: echo -n {{version}} > topgrade_keep
    working-directory: $HOME/.local/share
  - run:
      - test "$(topgrade --version)" = "Topgrade {{version}}"
      - topgrade --dry-run --disable system
    if: <16
  - run:
      - test "$(topgrade --version)" = "topgrade {{version}}"
      - topgrade --dry-run --disable system --allow-root
    if: '>=16'
