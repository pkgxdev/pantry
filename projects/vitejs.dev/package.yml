distributable: https://github.com/vitejs/vite/archive/refs/tags/v{{version.raw}}.tar.gz

versions:
  github: vitejs/vite/tags
  strip: /v/

dependencies:
  nodejs.org: ^16 || ^18 || ^20

build:
  dependencies:
    pnpm.io: "*"
    npmjs.com: "*"
    deno.land: ^1.39 # Required
  script: |
    cd vite-{{version.raw}}
    mkdir -p {{prefix}}/bin
    echo "node-linker=hoisted" >> .npmrc
    pnpm i
    cd packages/vite
    rm -rf ../../node_modules
    echo "node-linker=hoisted" >> .npmrc
    pnpm i
    sed -i 's/163/200/g' rollup.config.ts
    pnpm build
    cd ../..
    rm -rf node_modules
    pnpm i
    deno compile -o vite -Ar --unstable --unstable-byonm --node-modules-dir node_modules/vite/bin/vite.js
    cp vite {{prefix}}/bin/vite
  skip: fix-patchelf

test:
  script: |
    vite --version
    test "$(vite --version | grep -o 'vite/[^ ]*')" = "vite/{{version.raw}}"

provides:
  - bin/vite
