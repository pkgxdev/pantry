distributable: https://github.com/vitejs/vite/archive/refs/tags/v{{version.raw}}.tar.gz

versions:
  github: vitejs/vite/tags
  strip: /v/

dependencies:
  nodejs.org: ^16 || ^18 || ^20
  npmjs.com: "*"

build:
  dependencies:
    pnpm.io: "*"
  script: |
    cd vite-{{version.raw}}
    mkdir -p {{prefix}}/bin
    pnpm install
    cd packages/vite
    pnpm run build
    npm install --global --build-from-source --prefix={{prefix}} .
    rm -rf {{prefix}}/bin
    cp -r {{prefix}}/lib/* {{prefix}}/
    rm -rf {{prefix}}/lib
    mkdir -p {{prefix}}/bin
    cp {{prefix}}/node_modules/vite/bin/vite.js {{prefix}}/bin/vite

test:
  script: |
    vite --version
    test "$(vite --version | grep -o 'vite/[^ ]*')" = "vite/{{version.raw}}"

provides:
  - bin/vite
