distributable:
  url: https://github.com/bufbuild/buf/archive/refs/tags/v{{version}}.tar.gz
  strip-components: 1

versions:
  github: bufbuild/buf

provides:
  - bin/buf

build:
  script:
    - make build install
    - mkdir -p "{{ prefix }}"/bin
    - mv ~/.cache/buf/$PLATFORM/gobin/buf "{{ prefix }}"/bin
  dependencies:
    go.dev: ^1.20
    gnu.org/make: '*'
  env:
    darwin/aarch64: {PLATFORM: Darwin/arm64}
    darwin/x86-64:  {PLATFORM: Darwin/x64}
    linux/aarch64:  {PLATFORM: Linux/arm64}
    linux/x86-64:   {PLATFORM: Linux/x64}
    GO111MODULE: on
    CGO_ENABLED: 0
    linux:
      # or segmentation fault
      # fix found here https://github.com/docker-library/golang/issues/402#issuecomment-982204575
      LDFLAGS:
      - -buildmode=pie

test:
  buf --version | grep {{version}}
