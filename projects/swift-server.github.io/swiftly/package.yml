distributable:
  url: https://github.com/swift-server/swiftly/archive/{{version}}.tar.gz
  strip-components: 1
display-name: swiftly
warnings:
  - vendored
versions:
  github: swift-server/swiftly
platforms:
  - linux
runtime:
  env:
    SWIFTLY_BIN_DIR: "{{prefix}}/bin"
    SWIFTLY_HOME_DIR: "{{prefix}}/share"
dependencies:
    curl.se: '*'
build:
  script:
    - curl -L "https://github.com/swift-server/swiftly/releases/download/{{version}}/swiftly-$ARCH-unknown-linux-gnu" -o swiftly
    - mkdir -p {{prefix}}/bin
    - install ./swiftly {{prefix}}/bin/swiftly
    - chmod +x {{prefix}}/bin/swiftly

    # Create configuration file
    - run: |
        cat << EOF > config.json
        {
          "platform": {
            "name": "$PLATFORM_NAME",
            "nameFull": "$PLATFORM_NAME_FULL",
            "namePretty": "$PRETTY_NAME",
            "architecture": "$ARCH"
          },
          "installedToolchains": [],
          "inUse": null
        }
        EOF
      working-directory: "{{prefix}}/share"
  env:
    PRETTY_NAME: 'Ubuntu 22.04.3 LTS'
    PLATFORM_NAME: 'ubuntu2204'
    PLATFORM_NAME_FULL: 'ubuntu22.04'
    aarch64:
      ARCH: aarch64
    x86-64:
      ARCH: x86_64
provides:
  - bin/swiftly
test:
  script:
    - swiftly --version | grep {{version}}
    - swiftly install 5.9.2
    - swiftly list | grep 5.9.2
    - swift --version | grep 5.9.2
    - swift package init --type executable
    - swift run | grep "Hello, world!"
