distributable:
  url: https://github.com/Zouuup/landrun/archive/refs/tags/v{{version}}.tar.gz
  strip-components: 1

display-name: landrun

versions:
  github: Zouuup/landrun

platforms:
  - linux

build:
  dependencies:
    go.dev: '^1.18'
  script:
    - go mod download
    - go build -ldflags "$LDFLAGS" -o {{prefix}}/bin/landrun ./cmd/landrun
  env:
    LDFLAGS:
      - -s
      - -w
      - -buildmode=pie

provides:
  - bin/landrun

test:
  dependencies:
    curl.se: '*'
    gnu.org/coreutils: '*'
  env:
    linux/aarch64:
      # ARM64 GitHub Action runners don't support landlock, so we use --best-effort
      # on all positive tests to avoid failing the build. If landlock is supported
      # in the future, we can remove all --best-effort flags.
      LANDRUN_BEST_EFFORT: --best-effort
  script:
    # No permissions, should fail to execute any binary
    - if landrun true; then exit 1; fi
    # No filesystem permissions, should fail to read or write
    - if landrun --rox $PKGX_DIR/ ls /etc; then exit 1; fi
    - if landrun --rox $PKGX_DIR/ touch /tmp/landrun_should_fail; then exit 1; fi
    # Network not allowed by default, connecting out should fail
    - if landrun --rox $PKGX_DIR/ curl pkgx.sh > /dev/null; then exit 1; fi
    # Add read/write permissions
    - landrun $LANDRUN_BEST_EFFORT --rox $PKGX_DIR,/usr --ro /tmp ls /tmp
    - landrun $LANDRUN_BEST_EFFORT --rox $PKGX_DIR,/usr --rw /tmp touch /tmp/landrun_rw && test -f /tmp/landrun_rw
    - printf '#!/bin/sh\necho rox\n' >/tmp/x.sh && chmod +x /tmp/x.sh
    # Script present but without exec permission on /tmp should fail
    - if landrun --rox $PKGX_DIR,/usr --ro /tmp /tmp/x.sh; then exit 1; fi
    # Write should fail when only read-only access is granted
    - if landrun --rox $PKGX_DIR,/usr --ro /tmp touch /tmp/landrun_ro_should_fail; then exit 1; fi
    - landrun $LANDRUN_BEST_EFFORT --rox $PKGX_DIR,/usr --rwx /tmp /tmp/x.sh | grep '^rox$'
    - landrun $LANDRUN_BEST_EFFORT --rox $PKGX_DIR,/usr --env FOO=bar env | grep '^FOO=bar$'
    - landrun $LANDRUN_BEST_EFFORT --log-level debug --rox $PKGX_DIR,/usr true
