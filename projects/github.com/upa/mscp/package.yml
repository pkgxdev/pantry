distributable:
  url: git+https://github.com/upa/mscp
  ref: ${{version.tag}}

display-name: mscp

versions:
  github: upa/mscp

dependencies:
  zlib.net: ^1.2.11
  openssl.org: ^1.1.1
  #  kerberos.org: '*'

build:
  dependencies:
    gnu.org/bash: '*'
    #gnu.org/make: '*'
    #gnu.org/gcc: '*'
    llvm.org: '*'
    cmake.org: '*'
    git-scm.org: '*'
    python.org: '*'
    #kerberos.org: '*'
  env:
    CMAKE_BUILD_PREFIX: "./build"
    CMAKE_INSTALL_PREFIX: "{{ prefix }}"
    CMAKE_BUILD_TYPE: Release
    CMAKE_BUILD_STATIC: OFF
    CMAKE_BUILD_STATIC_LIB: OFF
    CMAKE_BUILD_SHARED_LIBS: ON
  script: |
    pip install libnacl
    #
    # this produce an error
    #
    # pip install abimap
    git submodule update --init
    patch -d libssh -p1 < patch/$(git --git-dir=./libssh/.git describe).patch
    #mkdir build && cd build
    cmake -B ${CMAKE_BUILD_PREFIX} \
          -D CMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE} \
          -D OPENSSL_ROOT_DIR={{deps.openssl.org.prefix}}
    #          -D BUILD_STATIC=${CMAKE_BUILD_STATIC} \
    #          -D BUILD_STATIC_LIB=${CMAKE_BUILD_STATIC_LIB} \
    #          -D BUILD_SHARED_LIBS=${CMAKE_BUILD_SHARED_LIBS}
    cmake --build ${CMAKE_BUILD_PREFIX} --config ${CMAKE_BUILD_TYPE}
    cmake --install ${CMAKE_BUILD_PREFIX} --prefix ${CMAKE_INSTALL_PREFIX}

provides:
  - bin/mscp

test: test "$(mscp|head -1|cut -d':' -f1|cut -d' ' -f2)" = v{{version}}
