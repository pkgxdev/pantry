distributable:
  url: https://github.com/containers/skopeo/archive/v{{ version }}.tar.gz
  strip-components: 1

versions:
  github: containers/skopeo/tags

provides:
  - bin/skopeo

dependencies:
  curl.se/ca-certs: "*"

build:
  dependencies:
    go.dev: "^1.18"
    github.com/cpuguy83/go-md2man: "*"
    tea.xyz/gx/make: "*"
    curl.se: "*"
    git-scm.org: "*"
  env:
    CGO_ENABLED: 0
  script: |
    # This makes skopeo a fully self-contained binary
    curl -fsSL https://github.com/containers/skopeo/pull/2014.diff | git apply
    make BUILDTAGS=containers_image_openpgp GO_DYN_FLAGS=
    mkdir -p '{{prefix}}/bin'
    mv -f ./bin/skopeo '{{prefix}}/bin'

test:
  script: |
    skopeo --version | tee /dev/stderr | grep -q -w '{{ version }}'

    skopeo --override-os linux inspect docker://busybox | tee /dev/stderr |
      grep -q -w 'docker.io/library/busybox'

    skopeo copy docker://alpine docker-archive:alpine.tar

    test -f alpine.tar
