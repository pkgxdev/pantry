distributable:
  url: https://github.com/containers/skopeo/archive/v{{ version }}.tar.gz
  strip-components: 1

versions:
  github: containers/skopeo/releases/tags

provides:
  - bin/skopeo

dependencies:
  curl.se/ca-certs: '*'

build:
  dependencies:
    go.dev: '^1.18'
    gnu.org/patch: '*'
  env:
    DISABLE_DOCS: 1 # disables the generation of man pages with go-md2man
  script:
    # https://github.com/containers/skopeo/pull/2014
    # https://github.com/felipecrs/skopeo-bin/pull/1
    - run: patch -p1 < props/embed-policy.patch
      if: <1.21.0

    # https://github.com/containers/skopeo/blob/2d1ae1fdb3d88347eec8a17d4415a964ce86d54f/install.md#building-a-static-binary
    - CGO_ENABLED=0 make BUILDTAGS=containers_image_openpgp GO_DYN_FLAGS=

    - mkdir -p '{{prefix}}/bin'
    - mv -f ./bin/skopeo '{{prefix}}/bin'

test:
  - skopeo --version | tee /dev/stderr | grep -q -w '{{ version }}'
  - run: cp $FIXTURE policy.json
    if: '>=1.21.0'
    working-directory: $HOME/.config/containers
    fixture: |
      {
        "default": [{ "type": "insecureAcceptAnything" }],
        "transports": {
          "docker-daemon": { "": [{"type":"insecureAcceptAnything"}]}
        }
      }
  - skopeo --override-os linux copy docker://hello-world docker-archive:hello-world.tar:example.com/hello-world
  - skopeo list-tags docker-archive:hello-world.tar | tee /dev/stderr | grep -q -w 'example.com/hello-world'
