distributable:
  url: https://github.com/mrtazz/checkmake/archive/refs/tags/{{version.tag}}.tar.gz
  strip-components: 1

versions:
  github: mrtazz/checkmake

build:
  dependencies:
    go.dev: ^1.21
  script:
    - run: BIN_PATH=./
      if: <0.3
    - run: BIN_PATH=./cmd/checkmake
      if: ">=0.3"
    - go build $ARGS -ldflags="$GO_LDFLAGS" $BIN_PATH
  env:
    ARGS:
      - -trimpath
      - -o={{prefix}}/bin/checkmake
      - -mod=mod
    GO_LDFLAGS:
      - -s
      - -w
      - -X 'main.version={{version}}'
      - -X 'main.goversion=go{{deps.go.dev.version}}'
      - -X 'main.buildTime=$(date)'
      - -X 'main.builder=pkgx'
    linux:
      GO_LDFLAGS:
        - -buildmode=pie

provides:
  - bin/checkmake

test:
  - checkmake --version | grep {{version}}
  - run: (checkmake $FIXTURE || true) 2>&1 | tee out
    fixture:
      extname: make
      content: |
        # this is a comment

        expanded = "$(simple)"
        simple := "foo"

        clean:
          rm bar
          rm foo

        foo: bar
          touch foo

        bar:
          touch bar

        all: foo

        test:
          @echo lolnah

        .PHONY: clean

        .DEFAULT_GOAL: all
  - run: grep 'Missing required phony target' out
    if: "<0.3"
  - run:
      - 'grep "Error: violations found" out'
      - grep "Required target" out
      - grep "declared PHONY" out
      - grep -F "PHONY." out
    if: ">=0.3"
