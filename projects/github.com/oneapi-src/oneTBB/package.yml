distributable:
  url: https://github.com/oneapi-src/oneTBB/archive/v{{version}}.tar.gz
  strip-components: 1

display-name: tbb

versions:
  github: oneapi-src/oneTBB
  strip: /^v/
  ignore: # they moved _to_ calver
    - /4\.4/

dependencies:
  python.org: ^3.11

runtime:
  env:
    PYTHONPATH: '{{prefix}}/lib/python{{deps.python.org.version.major}}/site-packages:$PYTHONPATH'

build:
  dependencies:
    cmake.org: '*'
    swig.org: '*'
    freedesktop.org/pkg-config: '*'
    linux:
      gnu.org/gcc: '>=4.8.5<11.2.1'
  working-directory: build
  script:
    #build shared
    - run: |
        cmake -S ../.. $CMAKE_ARGS -DBUILD_SHARED_LIBS=ON -DCMAKE_INSTALL_RPATH="{{prefix}}"
        cmake --build .
        cmake --install .
      working-directory: shared

    # build static
    - run: |
        cmake -S ../.. $CMAKE_ARGS -DBUILD_SHARED_LIBS=OFF -DCMAKE_INSTALL_RPATH="{{prefix}}"
        cmake --build . --parallel=1
        install ./*/libtbb*.a {{prefix}}/lib/
      working-directory: static
      
  env:
    linux:
      CC: gcc
      CXX: g++
    TBBROOT: "{{prefix}}"
    CMAKE_ARGS:
      - -DCMAKE_INSTALL_PREFIX="{{prefix}}
      - -DCMAKE_BUILD_TYPE=Release
      - -DCMAKE_FIND_FRAMEWORK=LAST
      - -DCMAKE_VERBOSE_MAKEFILE=ON
      - -Wno-dev
      - -DTBB_TEST=OFF

test:
  dependencies:
    freedesktop.org/pkg-config: '*'
  script:
    - pkg-config --modversion tbb | grep {{version}}
    - c++ cores-types.cpp $(pkg-config --libs tbb) -ltbb -o core-types
    - ./core-types
    - c++ sum1-100.cpp $(pkg-config --libs tbb) -o sum1-100
    - ./sum1-100 | grep 5050
    #- python -m TBB -h
    #- python -c "import TBB"
