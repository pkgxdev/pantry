distributable:
  url: https://github.com/oneapi-src/oneTBB/archive/v{{version}}.tar.gz
  strip-components: 1

display-name: tbb

versions:
  # github: oneapi-src/oneTBB parses the version incorrectly.
  github: oneapi-src/oneTBB
  strip: /^v/
  ignore: # they moved _to_ calver
    - /4\.4/

dependencies:
  python.org: ^3.11
  linux:
    open-mpi.org/hwloc: '*'

runtime:
  env:
    PYTHONPATH: '{{prefix}}/lib/python{{deps.python.org.version.major}}/site-packages:$PYTHONPATH'

build:
  dependencies:
    cmake.org: '*'
    swig.org: '*'
    freedesktop.org/pkg-config: '*'
    linux:
      gnu.org/gcc: '*'
  working-directory: build
  script:
    - run: |
        sed -i.bak "s|=\"0.2\"|=\"{{version}}\"|g" ../python/setup.py
        rm ../python/setup.py.bak
      if: darwin
    - cmake -S .. $CMAKE_ARGS -DBUILD_SHARED_LIBS=ON
    - cmake --build .
    - cmake --install .
    - run: |
        ln -s python{{deps.python.org.version.marketing}} python{{deps.python.org.version.major}}
      working-directory: ${{prefix}}/lib
    - run: |
        cmake -S .. $CMAKE_ARGS -DBUILD_SHARED_LIBS=OFF
        cmake --build .
        install ./*/libtbb*.a {{prefix}}/lib/
      working-directory: ../build-static
    - python3 -m pip install --prefix={{prefix}} ./python
  env:
    linux:
      CC: gcc
      CXX: g++
    CMAKE_PREFIX_PATH: "{{prefix}}:$CMAKE_PREFIX_PATH"
    TBBROOT: "{{prefix}}"
    CMAKE_ARGS:
      - -DCMAKE_INSTALL_PREFIX="{{prefix}}
      - -DCMAKE_BUILD_TYPE=Release
      - -DCMAKE_FIND_FRAMEWORK=LAST
      - -DCMAKE_VERBOSE_MAKEFILE=ON
      - -Wno-dev
      - -DTBB_TEST=OFF
      - -DTBB4PY_BUILD=ON
    PYTHONPATH: './build/lib/python{{deps.python.org.version.marketing}}/site-packages:./build-static/lib/python{{deps.python.org.version.marketing}}/site-packages:$PYTHONPATH'

test:
  dependencies:
    freedesktop.org/pkg-config: '*'
  script:
    - pkg-config --modversion tbb | grep {{version}}
    - c++ cores-types.cpp --std=c++14 -DTBB_PREVIEW_TASK_ARENA_CONSTRAINTS_EXTENSION=1 -ltbb -o core-types
    - ./core-types
    - c++ sum1-100.cpp --std=c++14 -DTBB_PREVIEW_TASK_ARENA_CONSTRAINTS_EXTENSION=1 -ltbb -o sum1-100
    - ./sum1-100 | grep 5050
    - python -m TBB -h
    - python -c "import TBB"
