# You may notice that this bottle named "mamba-org" refers to conda-forge github repo
# This is intentional and not an error

# cask: https://github.com/Homebrew/homebrew-cask/blob/c6e8fd99bdfd5ec217ff3b53505f42214f5cba58/Casks/mambaforge.rb

distributable:
  url: https://github.com/conda-forge/miniforge/archive/refs/tags/22.11.1-4.tar.gz #FIXME UGLY HACK, NEED TO MOVE '-4' TO versions.anytext 
  strip-components: 1

versions:
  - "22.11.1.4" # 

build:
#FIXME mamba provides sha256 signatures, should we check against them before building?
# https://github.com/conda-forge/miniforge/releases
  dependencies:
    curl.se: '*'
  script: |
    # download mamba installation script
    if [ -e "mamba.sh" ]; then
        echo 'File already exists'
    else
        curl -Lfo mamba.sh "https://github.com/conda-forge/miniforge/releases/download/22.11.1-4/Mambaforge-22.11.1-4-$PLATFORM.sh" #FIXME UGLY HACK, NEED TO MOVE '-4' TO versions.anytext
    fi

    pwd
    ls

    # install mamba
    chmod +x mamba.sh
    ./mamba.sh $ARGS #FIXME when running on gh actions, this fails
                     # ^ /opt/github.com/mamba-org/mamba/v22.11.1.4/bin/python: bad interpreter: No such file or directory

    # cleanup
    # rm mamba.sh


    #FIXME post-install, {{prefix}}/bin should ideally be added to path,
    # ^ because that's the point of using mamba: you do a `mamba install pkg_name` 
    # ^ and then you should be able to use `pkg_name` in your shell.
    # ^ at the moment, I'm not sure whether this should be a default behaviour of tea,
    # ^ or whether it should be up to a user to add the correct path to their shell config.
    # export PATH="${{prefix}}/bin:$PATH"

  env:
    # env-dependent vars
    darwin/aarch64: {PLATFORM: MacOSX-arm64}
    darwin/x86-64:  {PLATFORM: MacOSX-x86_64}
    linux/aarch64:  {PLATFORM: Linux-aarch64}
    linux/x86-64:   {PLATFORM: Linux-x86_64}
    # mamba install args 
    ARGS:
      - -b                 # skip interactive - accept all licence agreements
      - -s                 # skip running pre/post-link/install scripts
      - -u                 # update if already installed 
      - -p {{prefix}}      # prefix - where to install #FIXME what if I use a relative link here? will the shebang in `mamba` also become relative?

test: |
  # ln -s {{prefix}} /opt
  ln -s /home/runner/.tea /opt #FIXME because build uses a different folder, need this fixture for test-time
  # /home/runner/.tea/github.com/mamba-org/mamba/v22.11.1.4/bin/mamba   # test env
  #              /opt/github.com/mamba-org/mamba/v22.11.1.4/bin/python  # shebang
  sleep 1 #FIXME this is a hack to wait for the installation to finish
  pwd
  sleep 1
  ls {{prefix}}
  sleep 1
  ls {{prefix}}/bin
  sleep 1
  mamba --version
  which python #FIXME test that this is mamba-provided python, not system python
  python -c "print('Hello World!')" #FIXME this should be a proper test


provides:
  - bin/mamba #FIXME is this the correct provides?
  - bin/python #FIXME make sure this python does not conflict with https://tea.xyz/+python.org/


#FIXME: add caveats
# ^     Please run the following to setup your shell:
# ^       conda init "$(basename "${SHELL}")"
