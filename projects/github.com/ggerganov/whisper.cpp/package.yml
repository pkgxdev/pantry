distributable:
  url: https://github.com/ggerganov/whisper.cpp/archive/refs/tags/v{{version}}.tar.gz
  strip-components: 1

versions:
  github: ggerganov/whisper.cpp/tags

provides:
  - bin/whisper.main
  - bin/whisper.stream 
  - bin/whisper.command 

dependencies:
  gnu.org/wget: '*'

build:
  dependencies:
    tea.xyz/gx/cc: c99
    tea.xyz/gx/make: '*'
    freedesktop.org/pkg-config: ~0.29
    libsdl.org: '*'
    gnu.org/patch: '*'
  script: |
    patch -p1 < props/illegal_instruction.patch 

    mkdir -p {{prefix}}/bin {{prefix}}/tbin/models {{prefix}}/share
    
    make clean --jobs {{ hw.concurrency }} 
    make 
    make stream 
    make command 
    
    mv main {{prefix}}/tbin/main
    mv stream {{prefix}}/tbin/stream
    mv command {{prefix}}/tbin/command 

    mv models/download-ggml-model.sh {{prefix}}/tbin/models/download-ggml-model.sh

    mv props/main.sh {{prefix}}/bin/whisper.main
    mv props/stream.sh {{prefix}}/bin/whisper.stream
    mv props/command.sh {{prefix}}/bin/whisper.command
    mv props/whisper-fetch.sh {{prefix}}/tbin/whisper-fetch
    
    mv samples/jfk.wav {{prefix}}/share
    mv examples/command/commands.txt {{prefix}}/share

    chmod +x {{prefix}}/tbin/main
    chmod +x {{prefix}}/bin/whisper.main

    chmod +x {{prefix}}/tbin/stream
    chmod +x {{prefix}}/bin/whisper.stream

    chmod +x {{prefix}}/tbin/command
    chmod +x {{prefix}}/bin/whisper.command

    chmod +x {{prefix}}/tbin/whisper-fetch

test: |
  whisper.main -f {{prefix}}/share/jfk.wav --print-colors
