distributable:
  url: https://github.com/ggerganov/whisper.cpp/archive/refs/tags/v{{version}}.tar.gz
  strip-components: 1

versions:
  github: ggerganov/whisper.cpp/tags

provides:
  - bin/whisper.cpp

build:
  dependencies:
    tea.xyz/gx/cc: c99
    tea.xyz/gx/make: '*'
    freedesktop.org/pkg-config: ~0.29
  script: |
    mkdir -p {{prefix}}/bin {{prefix}}/tbin {{prefix}}/share
    
    bash ./models/download-ggml-model.sh base.en
    make --jobs {{ hw.concurrency }} 
    
    mv main {{prefix}}/bin/whisper.cpp
    mv whisper.cpp {{prefix}}/tbin/whisper.cpp 
    mv models/ggml-base.en.bin {{prefix}}/tbin/ggml-base.en.bin
    mv samples/jfk.wav {{prefix}}/share

    chmod +x {{prefix}}/tbin/whisper.cpp
    chmod +x {{prefix}}/bin/whisper.cpp
  # TODO: What if you do not want the base model?
  env:
    ARGS:
      - --prefix="{{prefix}}"

test: |
  whisper.cpp -m {{prefix}}/tbin/ggml-base.en.bin -f {{prefix}}/share/jfk.wav --print-colors
# testing more than this requires downloading the models ðŸ˜¬