distributable:
  # url format changed in v0.2.1
  #url: https://github.com/AntonOsika/gpt-engineer/archive/refs/tags/v{{version}}.tar.gz
  url: https://github.com/AntonOsika/gpt-engineer/archive/refs/tags/{{version}}.tar.gz
  strip-components: 1

versions:
  github: AntonOsika/gpt-engineer

display-name: GPT Engineer

dependencies:
  pkgx.sh: ^1

entrypoint: pkgx ./entrypoint.sh

build:
  dependencies:
    python.org: ~3.11
    python-poetry.org: ^1.7
  script:
    # https://github.com/AntonOsika/gpt-engineer/issues/204
    - run: patch -p1 < props/main.py.patch
      if: =0.0.3

    - run: |
        bkpyvenv stage --engine=poetry {{prefix}} {{version}}
        poetry install --with=experimental
        bkpyvenv seal --engine=poetry {{prefix}} gpt-engineer
      if: '>=0.2.1'

    - run: |
        bkpyvenv stage {{prefix}} {{version}}
        {{prefix}}/venv/bin/pip install .
        bkpyvenv seal {{prefix}} gpt-engineer
      if: '<0.2.1'

    # https://github.com/AntonOsika/gpt-engineer/issues/204
    - run: cp -a identity {{prefix}}
      if: =0.0.3

    - cp props/entrypoint.sh {{prefix}}

provides:
  - bin/gpt-engineer

test:
  qa-required: true
  script:
    - gpt-engineer --help
    # verifies that python cannot have been available to gpt-engineer in any
    # other way than via pkgx in the commandâ€™s pkgx shim
    - if command -v python; then exit 1; fi
