distributable:
  url: git+https://github.com/awslabs/llrt
  ref: ${{version.tag}}

provides:
  - bin/llrt

versions:
  github: awslabs/llrt
  strip:
    - /v/
    - /-beta/ # not great practice, but it's all they have atm

build:
  dependencies:
    rust-lang.org/rustup: "*" # manages its own rust :/
    facebook.com/zstd: "*" # builds its own, still needs our cli
    nodejs.org: "*"
    yarnpkg.com: "*"
    cmake.org: "*"
    git-scm.org: "*"
  script:
    - run:
        - ln -sf {{deps.rust-lang.org/rustup.prefix}}/bin/rustup rustup
        - rustup default nightly
        - rustup component add rust-src
        - ln -sf $HOME/.rustup/toolchains/*/bin/* .
      working-directory: $HOME/.cargo/bin

    - git submodule update --init --checkout
    - yarn
    - node build.mjs

    # missed version bump
    - run: find . -name Cargo.toml -print0 | xargs -0 sed -i 's/ = "0.8.0-beta"/ = "{{version}}-beta"/g'
      if: =0.8.1

    - cargo install --path llrt --root {{prefix}}
  env:
    PATH: $HOME/.cargo/bin:$PATH # rustup

test:
  - llrt --version
  - llrt --version | grep {{version}}
  - run: test "$(llrt $FIXTURE)" = "Hello, world!"
    fixture:
      extname: js
      content: console.log("Hello, world!")
