distributable:
  url: https://github.com/TomWright/dasel/archive/refs/tags/{{version.tag}}.tar.gz
  strip-components: 1

versions:
  github: TomWright/dasel/tags

build:
  dependencies:
    go.dev: ^1
  env:
    GOBIN: '{{prefix}}/bin'
    GO_LDFLAGS:
      - -X 'github.com/tomwright/dasel/v2/internal.Version={{version}}'
      - -X 'github.com/tomwright/dasel/v3/internal.Version={{version}}'
    linux:
      # or segmentation fault
      # fix found here https://github.com/docker-library/golang/issues/402#issuecomment-982204575
      GO_LDFLAGS:
        - -buildmode=pie
  working-directory: cmd/dasel
  script: go install -ldflags="$GO_LDFLAGS"

provides:
  - bin/dasel

test:
  - run:
      - test "$(dasel --version)" = "dasel version {{version}}"
      - EXEC="-r json"
    if: <3
  - run:
      - test "$(dasel version)" = "{{version}}"
      - EXEC="query"
    if: '>=3'
  - run: test "$(cat $FIXTURE | dasel $EXEC 'hello.world')" = '"Hello, World!"'
    fixture:
      extname: json
      content: |
        {
          "hello": {
            "world": "Hello, World!"
          }
        }
