distributable: ~

display-name: nullclaw

versions:
  github: nullclaw/nullclaw

warnings:
  - vendored

provides:
  - bin/nullclaw
  - bin/nullclaw-init

dependencies:
  github.com/mikefarah/yq: "*"
  stedolan.github.io/jq: "*"
  gnu.org/sed: "*"

build:
  dependencies:
    curl.se: "*"
  script:
    - curl -fsSL "https://github.com/nullclaw/nullclaw/releases/download/{{version.tag}}/${ASSET}" -o nullclaw
    - install -Dm755 nullclaw {{prefix}}/bin/nullclaw
    - install -Dm755 props/nullclaw-init {{prefix}}/bin/nullclaw-init
  env:
    darwin/aarch64:
      ASSET: nullclaw-macos-aarch64.bin
    darwin/x86-64:
      ASSET: nullclaw-macos-x86_64.bin
    linux/aarch64:
      ASSET: nullclaw-linux-aarch64.bin
    linux/x86-64:
      ASSET: nullclaw-linux-x86_64.bin

test:
  dependencies:
    crates.io/semverator: "*"
  script:
    # requires GLIBC_2.34
    - run:
        - LIBCV=$(getconf GNU_LIBC_VERSION | sed 's/^glibc //')
        - |
          if ! semverator gt $LIBCV 2.34; then
            echo "Skipping test on glibc $LIBCV"
            exit 0
          fi
      if: linux
    - nullclaw --version
    - run: nullclaw help >/dev/null 2>&1 || true
    - run: nullclaw-init --help | grep -q 'nullclaw-init'
    - run:
        - export OPENROUTER_API_KEY="test-key"
        - nullclaw-init $FIXTURE --write-only --output ./nullclaw-config.json
        - test -f ./nullclaw-config.json
        - jq -e '.agents.defaults.model.primary == "openrouter/anthropic/claude-sonnet-4"' ./nullclaw-config.json
        - jq -e '.models.providers.openrouter.api_key == "test-key"' ./nullclaw-config.json
      fixture:
        extname: md
        content: |
          ---
          agent:
            id: "support-bot"
            model:
              provider: "openrouter"
              primary: "openrouter/anthropic/claude-sonnet-4"
            defaults:
              temperature: 0.3
              heartbeat_every: "30m"
          auth:
            provider_api_key_env: "OPENROUTER_API_KEY"
          runtime:
            workspace: "."
            workspace_only: true
            allow_public_bind: false
            tools_allowlist:
              - "shell"
              - "file_read"
          memory:
            backend: "sqlite"
            embedding_provider: "noop"
            vector_weight: 0.7
            keyword_weight: 0.3
            hygiene_enabled: true
          channels:
            telegram:
              enabled: false
              account_id: "main"
              bot_token_env: "TELEGRAM_BOT_TOKEN"
              allow_from: []
            discord:
              enabled: false
              account_id: "main"
              token_env: "DISCORD_BOT_TOKEN"
              guild_id: ""
              allow_from: []
          launch:
            mode: "agent"
            first_message: "Hello, nullclaw!"
          ---
