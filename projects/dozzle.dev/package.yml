distributable:
  url: https://github.com/amir20/dozzle/archive/refs/tags/v{{version}}.tar.gz
  strip-components: 1

versions:
  github: amir20/dozzle

provides:
  - bin/dozzle

build:
  dependencies:
    go.dev: ^1.21
    npmjs.com: '*'
    openssl.org: '*'
  script:
    - make -j {{hw.concurrency}} tools
    - run: cp ~/go/bin/* .
      working-directory: ${{prefix}}/bin
    - npm install $NPM_ARGS
    - go build -ldflags "$GO_LDFLAGS" -o {{prefix}}/bin/dozzle .
  env:
    CGO_ENABLED: 0
    GO_LDFLAGS:
      - -s
      - -w
      - -X github.com/amir20/dozzle/internal/support/cli.Version={{version}}
    NPM_ARGS:
      - -ddd
      - --global
      - --build-from-source
      - --prefix={{prefix}}
      - --install-links
      - --unsafe-perm

test: dozzle --version | grep {{version}}
