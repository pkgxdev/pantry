distributable:
  url: git+https://github.com/railwayapp/cli.git
  ref: ${{version.tag}}

versions:
  github: railwayapp/cli

build:
  dependencies:
    rust-lang.org: ^1.77
    rust-lang.org/cargo: "*"
    darwin:
      gnu.org/libiconv: "*" # transitive, but we need it here to get it *out*
  script:
    # 3.5.2 didn't bump version
    - run: sed -i 's/^version = ".*"$/version = "{{version}}"/' Cargo.toml
    - cargo add proc-macro2
    - cargo install $ARGS
    # something weird is causing it to link in unneeded iconv in 4.27.5
    - run:
        - otool -l railway | grep libiconv
        - install_name_tool -change "@rpath/gnu.org/libiconv/v{{deps.gnu.org/libiconv.version}}/lib/libiconv.2.dylib" "/usr/lib/libiconv.2.dylib" railway
        - otool -l railway | grep libiconv
      if: darwin
      working-directory: ${{prefix}}/bin
  env:
    ARGS:
      - --root={{prefix}}
      - --path=.
      - --locked

provides:
  - bin/railway

test:
  - (railway init 2>&1 || true) | tee out
  - grep 'Unauthorized. Please login with `railway login`' out
  - railway --version | grep {{version}}
