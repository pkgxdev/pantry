distributable:
  url: https://github.com/Xpra-org/xpra/archive/refs/tags/v{{version}}.tar.gz
  strip-components: 1

versions:
  github: Xpra-org/xpra
  strip: /^xpra /

platforms:
  - linux

runtime:
  env:
    GI_TYPELIB_PATH_GOBJECT_INTROSPECTION: "{{pkgx.prefix}}/gnome.org/gobject-introspection/v{{deps.gnome.org/gobject-introspection.version}}/lib/girepository-1.0"
    GI_TYPELIB_PATH_GTK3: "{{pkgx.prefix}}/gtk.org/gtk3/v{{deps.gtk.org/gtk3.version}}/lib/girepository-1.0"
    GI_TYPELIB_PATH_PANGO: "{{pkgx.prefix}}/gnome.org/pango/v{{deps.gnome.org/pango.version}}/lib/girepository-1.0"
    GI_TYPELIB_PATH_HARFBUZZ: "{{pkgx.prefix}}/harfbuzz.org/v{{deps.harfbuzz.org.version}}/lib/girepository-1.0"
    GI_TYPELIB_PATH_GDK_PIXBUF: "{{pkgx.prefix}}/gnome.org/gdk-pixbuf/v{{deps.gnome.org/gdk-pixbuf.version}}/lib/girepository-1.0"
    GI_TYPELIB_PATH_ATK: "{{pkgx.prefix}}/gnome.org/atk/v{{deps.gnome.org/atk.version}}/lib/girepository-1.0"
    GI_TYPELIB_PATH: $GI_TYPELIB_PATH_GOBJECT_INTROSPECTION:$GI_TYPELIB_PATH_GTK3:$GI_TYPELIB_PATH_PANGO:$GI_TYPELIB_PATH_HARFBUZZ:$GI_TYPELIB_PATH_GDK_PIXBUF:$GI_TYPELIB_PATH_ATK:$GI_TYPELIB_PATH

dependencies:
  python.org: '~3.11'
  cython.org: '*'
  tukaani.org/xz: '*'
  cairographics.org: '*'
  cairographics.org/pycairo: '1.26.1'
  freedesktop.org/pkg-config: ~0.29
  gnome.org/PyGObject: '*'
  gnome.org/glib: '*'

  x.org/x11: '*'
  x.org/protocol: '*'
  x.org/exts: '*'

  x.org/xkbfile: '*'
  x.org/xdamage: '*'
  x.org/xrandr: '*'
  x.org/xcomposite: '*'

  x.org/xtst: '*'
  x.org/libxres: '*'
  x.org/xfixes : '*'

  videolan.org/x264: '*'
  webmproject.org/libvpx: '*'
  github.com/AOMediaCodec/libavif: '*'

  github.com/Cyan4973/xxHash: '*'

  gtk.org/gtk3: '*'
  gnome.org/gobject-introspection: '*'

  harfbuzz.org: '*'
  gnome.org/gdk-pixbuf: '*'
  gnome.org/atk: '*'
  gnome.org/pango: '*'

build: 
  dependencies:
    freedesktop.org/pkg-config: ~0.29 
    python.org: '~3.11'
    cython.org: '*'
    tukaani.org/xz: '*'
    cairographics.org: '*'
    cairographics.org/pycairo: '1.26.1'
    gnome.org/PyGObject: '*'
    gnome.org/glib: '*'

    x.org/x11: '*'
    x.org/protocol: '*'
    x.org/exts: '*'

    x.org/xkbfile: '*'
    x.org/xdamage: '*'
    x.org/xrandr: '*'
    x.org/xcomposite: '*'

    x.org/xtst: '*'
    x.org/libxres: '*'
    x.org/xfixes : '*'

    videolan.org/x264: '*'
    webmproject.org/libvpx: '*'
    github.com/AOMediaCodec/libavif: '*'

    github.com/Cyan4973/xxHash: '*'

    gtk.org/gtk3: '*'
    gnome.org/gobject-introspection: '*'

    harfbuzz.org: '*'
    gnome.org/gdk-pixbuf: '*'
    gnome.org/atk: '*'
    gnome.org/pango: '*'

  script:
    # The following part generates a py3cairo.pc file for pkg-config to pick up the py3cairo.h file.
    # Unfortunatelly, this is needed because the pycairo package does not provide a .pc file (see: https://github.com/pygobject/pycairo/issues/270)
    # At the same time, the xpra maintainers do not want to rely on another method to find the py3cairo.h file (see: https://github.com/Xpra-org/xpra/issues/4358)
    # For reference, some distributions provide a py3cairo.pc file in a separate package (e.g. https://packages.debian.org/buster/all/python3-cairo-dev/filelist)
    # Discussion in pkgx/pantry: https://github.com/pkgxdev/pantry/issues/7290
    # TODO: Find a better solution â€“ e.g. Introduce a cairographics.org/pycairo-dev package
    - run: |
        PKGX_ROOT="{{pkgx.prefix}}"
        PYCAIRO_INCLUDE_FILE=$(find ${PKGX_ROOT} -name 'py3cairo.h' -exec echo {} \; | grep 'cairographics.org/pycairo')
        PYCAIRO_INCLUDE_DIR=$(dirname $PYCAIRO_INCLUDE_FILE)
        PYCAIRO_PREFIX=$(dirname "${PYCAIRO_INCLUDE_DIR}/../../../../../..")
        PYCAIRO_VERSION="{{deps.cairographics.org/pycairo.version}}"
        mkdir -p $PYCAIRO_INCLUDE_DIR/pycairo
        ln -s $PYCAIRO_INCLUDE_DIR/py3cairo.h $PYCAIRO_INCLUDE_DIR/pycairo/py3cairo.h || true
        echo "prefix=${PYCAIRO_PREFIX}" > py3cairo.pc
        echo "" >> py3cairo.pc
        echo "Name: Pycairo" >> py3cairo.pc 
        echo "Description: Python bindings for the cairo graphics library" >> py3cairo.pc
        echo "Version: ${PYCAIRO_VERSION}" >> py3cairo.pc
        echo "Requires: cairo" >> py3cairo.pc
        echo "Cflags: -I${PYCAIRO_INCLUDE_DIR}" >> py3cairo.pc
        echo "Libs:" >> py3cairo.pc
    # Actual build script follows
    - run: |
        bkpyvenv stage {{prefix}} {{version}}
        {{prefix}}/venv/bin/pip install .
        bkpyvenv seal {{prefix}} xpra
    # Clean up intermediate `py3cairo.pc` file
    - run: rm py3cairo.pc
  env:
    PKG_CONFIG_PATH: ".:$PKG_CONFIG_PATH"
      
provides:
  - bin/xpra

test:
  script:
    xpra --version | grep -q "{{version}}"
