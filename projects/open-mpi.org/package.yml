distributable:
  url: https://download.open-mpi.org/release/open-mpi/v{{version.marketing}}/openmpi-{{version}}.tar.bz2
  strip-components: 1

versions:
  github: open-mpi/ompi/tags

dependencies:
  open-mpi.org/hwloc: '*'
  libevent.org: '*'

build:
  dependencies:
    tea.xyz/gx/make: '*'
    darwin:
      gnu.org/autoconf: '*'
      tea.xyz/gx/cc: c99
    linux:
      gnu.org/gcc: '*'
      
  script:
    - ./configure $ARGS
    - make --jobs {{ hw.concurrency }} all
    - make --jobs {{ hw.concurrency }} check
    - make --jobs {{ hw.concurrency }} install
    - run: |
        install {{prefix}}/lib/*.mod {{prefix}}/include/
        sed -i.bak 's|{{prefix}}|${pcfiledir}/../..|g' {{prefix}}/lib/pkgconfig/*.pc
        rm {{prefix}}/lib/pkgconfig/*.bak
      if: linux
    - run: |
        find {{prefix}}/lib/pkgconfig/ -type f ! -name '*.*' -exec sed -i.bak 's|{{prefix}}|${pcfiledir}/../..|g' {} +
        rm {{prefix}}/lib/pkgconfig/*.bak
      if: darwin
    
  env:
    darwin:
      CC: "{{deps.tea.xyz/gx/cc.prefix}}/bin/clang"
      CXX: "{{deps.tea.xyz/gx/cc.prefix}}/bin/c++"
    linux:
      CC: "{{deps.gnu.org/gcc.prefix}}/bin/gcc"
      CXX: "{{deps.gnu.org/gcc.prefix}}/bin/g++"
    ARGS:
      - --prefix="{{prefix}}"
      - --disable-silent-rules
      - --enable-ipv6
      - --enable-mca-no-build=reachable-netlink
      - --sysconfdir={{prefix}}/etc
      - --with-libevent={{deps.libevent.org.prefix}}
      - --with-sge
      - --disable-debug
      - --disable-dependency-tracking

provides:
  - bin/mpic++
  - bin/mpiCC
  - bin/mpicc
  - bin/mpicxx
  - bin/mpiexec
  - bin/mpif77
  - bin/mpif90
  - bin/mpifort
  - bin/mpirun
  - bin/ompi-clean
  - bin/ompi_info
  - bin/ompi-server
  - bin/opal_wrapper
  - bin/ortecc
  - bin/orte-clean
  - bin/orted
  - bin/orte-info
  - bin/orterun
  - bin/orte-server

test:
  dependencies:
    freedesktop.org/pkg-config: '*'
  script:
    - pkg-config --modversion ompi | grep {{version}}
    - mpicc hello.c -o hello
    - ./hello
    - mpirun ./hello