distributable:
  url: https://download.open-mpi.org/release/open-mpi/v{{version.marketing}}/openmpi-{{version}}.tar.bz2
  strip-components: 1

versions:
  github: open-mpi/ompi/tags

dependencies:
  gnu.org/gcc: '*'
  open-mpi.org/hwloc: '*'
  libevent.org: '*'

build:
  dependencies:
    tea.xyz/gx/make: '*'

    darwin:
      gnu.org/autoconf: '*'
      
  script:
    - sed -i'' -e "s|OMPI_CXX_ABSOLUTE|$CXX|g" $FILES
    - sed -i'' -e "s|OPAL_CC_ABSOLUTE|$CC|g" $FILES
    - sed -i'' -e "s|PMIX_CC_ABSOLUTE|$CC|g" $FILES
    - ./configure $ARGS
    - make --jobs {{ hw.concurrency }} all
    - make --jobs {{ hw.concurrency }} check
    - make --jobs {{ hw.concurrency }} install
    - mv {{prefix}}/lib/*.mod {{prefix}}/include/
    
  env:
    FILES:
      - ompi/tools/ompi_info/param.c
      - oshmem/tools/oshmem_info/param.c
    linux:
      CXX: g++
      CC: gcc
    darwin:
      MACOSX_DEPLOYMENT_TARGET: "$(sw_vers -productVersion)"
    ARGS:
      - --prefix="{{prefix}}"
      - --disable-silent-rules
      - --enable-ipv6
      - --enable-mca-no-build=reachable-netlink
      - --sysconfdir={{prefix}}/etc
      - --with-libevent={{deps.libevent.org.prefix}}
      - --with-sge
      - --disable-debug
      - --disable-dependency-tracking

provides:
  - bin/mpic++
  - bin/mpiCC
  - bin/mpicc
  - bin/mpicxx
  - bin/mpiexec
  - bin/mpif77
  - bin/mpif90
  - bin/mpifort
  - bin/mpirun
  - bin/ompi-clean
  - bin/ompi_info
  - bin/ompi-server
  - bin/opal_wrapper
  - bin/ortecc
  - bin/orte-clean
  - bin/orted
  - bin/orte-info
  - bin/orterun
  - bin/orte-server

test:
  dependencies:
    freedesktop.org/pkg-config: '*'
  script:
    - pkg-config --modversion ompi | grep {{version}}
    - mpicc hello.c -o hello
    - ./hello
    - mpirun ./hello