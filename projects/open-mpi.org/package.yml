distributable:
  url: https://download.open-mpi.org/release/open-mpi/v{{version.marketing}}/openmpi-{{version}}.tar.bz2
  strip-components: 1
versions:
  github: open-mpi/ompi/tags
dependencies:
  open-mpi.org/hwloc: '*'
  libevent.org: '*'
  gnu.org/gcc: '*' # for gfortran
build:
  dependencies:
    gnu.org/make: '*'
  script:
    - ./configure $CONFIGURE_ARGS
    - make --jobs {{ hw.concurrency }} all
    - make --jobs {{ hw.concurrency }} check
    - make --jobs {{ hw.concurrency }} install
    - run: |
        sed -i.bak "s|$TEA_PREFIX|\${pcfiledir}/../../../..|g" ./*.pc
        rm ./*.bak
      working-directory: "{{prefix}}/lib/pkgconfig"
    - install {{prefix}}/lib/*.mod {{prefix}}/include/
  env:
    CXX: "g++ -std=c++11"
    CONFIGURE_ARGS:
      - --disable-debug
      - --disable-dependency-tracking
      - --prefix="{{prefix}}"
      - --libdir="{{prefix}}/lib"
      - --disable-silent-rules
      - --enable-ipv6
      - --enable-mca-no-build=reachable-netlink
      - --sysconfdir="{{prefix}}/etc"
      - --with-libevent="{{deps.libevent.org.prefix}}"
      - --with-sge
provides:
  - bin/mpic++
  - bin/mpiCC
  - bin/mpicc
  - bin/mpicxx
  - bin/mpiexec
  - bin/mpif77
  - bin/mpif90
  - bin/mpifort
  - bin/mpirun
  - bin/ompi-clean
  - bin/ompi_info
  - bin/ompi-server
  - bin/opal_wrapper
  - bin/ortecc
  - bin/orte-clean
  - bin/orted
  - bin/orte-info
  - bin/orterun
  - bin/orte-server
test:
  dependencies:
    freedesktop.org/pkg-config: '*'
  script:
    - mpicc hello.c -o hello
    - ./hello
    - mpirun ./hello
    - mpifort hellof.f90 -o hellof
    - ./hellof
    - mpirun ./hellof
    - mpifort hellousempi.f90 -o hellousempi
    - ./hellousempi
    - mpirun ./hellousempi
    - mpifort hellousempif08.f90 -o hellousempif08
    - ./hellousempif08
    - mpirun ./hellousempif08
    - pkg-config --modversion ompi