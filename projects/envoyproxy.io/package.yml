distributable:
  url: https://github.com/envoyproxy/envoy/archive/refs/tags/{{version.tag}}.tar.gz
  strip-components: 1

versions:
  github: envoyproxy/envoy

build:
  dependencies:
    github.com/bazelbuild/bazelisk: '*'
    gnu.org/automake: '*'
    cmake.org: '*'
    gnu.org/libtool: '*'
    ninja-build.org: '*'
    linux:
      gnu.org/gcc: '*' # doesn't like clang; missing `version` header
    python.org: '*'
    git-scm.org: '*'
  script:
    # Initialize Git repo as Bazel requires git for workspace status
    - git init
    - git config --global user.email "pkgx-build@example.com"
    - git config --global user.name "pkgx build"
    - git add .
    - git commit -m "Initialize repository"
    
    - bazel build $BAZEL_OPTS //source/exe:envoy-static.stripped
    - install -m 755 -D bazel-bin/source/exe/envoy-static.stripped {{prefix}}/bin/envoy
  env:
    linux:
      BAZEL_LINKOPTS: "-lm"
      BAZEL_LINKLIBS: "-lstdc++ -lm"
    BAZEL_OPTS:
      - --compilation_mode=opt
      - --curses=no
      - --verbose_failures
      - --define=wasm=disabled
      
provides:
  - bin/envoy

test:
  - envoy --version | grep {{version}}
  - envoy --help
