name: indexer

on:
  cron:
    schedule:
      - 13,26,39,52 3,9,15,21 * * *
      # this schedule triggers a job 4 times a day, at intervals that aren't on
      # the hour or half hour, which can be considered unusual. Specifically, it
      # runs at 3:13, 3:26, 3:39, 3:52, 9:13, 9:26, 9:39, 9:52, 15:13, 15:26,
      # 15:39, 15:52, 21:13, 21:26, 21:39 and 21:52
  pull_request:
    - .github/scripts/utils/indexer.ts
    - .github/workflows/indexer.yml
  push:
    branches: main
    paths:
      - projects/**/package.yml
      - .github/scripts/utils/indexer.ts
      - .github/workflows/indexer.yml

concurrency:
  group: indexer
  cancel-in-progress: true

jobs:
  new-pkgs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: pkgxdev/setup@v2
        with:
          +: deno

      - run: mkdir out
      - run: deno run -A .github/scripts/utils/indexer.ts > out/pkgs.json

      - uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: out
