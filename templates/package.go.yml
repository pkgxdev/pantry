# Replace all __VALUE__ values with the appropriate value
# Index:
# - __ORG__: GitHub organization name
# - __REPO__: GitHub repository name
# - __DEP__: Dependency name
# - __DEP_VERSION__: Dependency version
# - __ADDITIONAL_ARGS__: Additional arguments to pass to configure
# - __BINS__: List of binaries to provide
# - __BIN__: Binary to test
# - __RESULT__: Result to test for
# - __FIXTURE__: Fixture to test with

distributable:
  url: https://github.com/__ORG__/__REPO__/archive/refs/tags/v{{version}}.tar.gz
  strip-components: 1

versions:
  github: __ORG__/__REPO__
  strip: /^v /

dependencies:
  __DEP__: __DEP_VERSION__

build:
  dependencies:
    go.dev: ^1.18
    __DEP__: __DEP_VERSION__
  script: |
    go build -v -ldflags="$LDFLAGS"
    mkdir -p "{{ prefix }}"/bin
    mv __BINS__ "{{ prefix }}"/bin
  env:
    LDFLAGS:
      [-s, -w, "-X=main.Version={{version}}"]
    linux:
      # or segmentation fault
      # fix found here https://github.com/docker-library/golang/issues/402#issuecomment-982204575
      LDFLAGS:
      - -buildmode=pie


provides:
  - bin/__BINS__

test:
  dependencies:
    __DEP__: __DEP_VERSION__
  script:
    test "$(__BIN__ do_something $FIXTURE)" = "__RESULT__"
  fixture: |
    __FIXTURE__
